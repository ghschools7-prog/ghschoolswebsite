<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard</title>
  <link rel="icon" type="image/png" href="images/favicon.png" />
  <!-- Paystack Inline -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <!-- jsPDF (only one instance needed) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    body { background-color: #fef7f7; padding: 20px; animation: fadeIn 1s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    .container { 
      background: white; 
      border-radius: 20px; 
      display: grid; 
      grid-template-columns: 280px 1fr; 
      max-width: 1300px; 
      margin: auto; 
      overflow: hidden; 
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.968); 
      position: relative; 
      border: 1px solid #ffeeba;
    }
    
    .sidebar { 
      background: linear-gradient(180deg, #ff1100, #ff0019); 
      color: white; 
      display: flex; 
      flex-direction: column; 
      padding: 30px 0; 
      gap: 15px; 
      align-items: flex-start; 
      transition: all 0.3s ease; 
      border-right: 1px solid #ffc107;
    }
    
    .sidebar a { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      padding: 12px 25px; 
      color: white; 
      text-decoration: none; 
      width: 100%; 
      font-weight: 500;
      transition: all 0.2s ease;
      border-left: 4px solid transparent;
    }
    
    .sidebar a:hover { 
      background: rgba(255, 255, 255, 0.15); 
      color: #ffeb3b; 
      border-left: 4px solid #ffeb3b;
    }
    
    .sidebar a.active { 
      background: rgba(255, 255, 255, 0.1); 
      color: #ffeb3b; 
      border-left: 4px solid #ffeb3b;
    }
    
    .main { 
      padding: 25px 30px; 
      display: flex; 
      flex-direction: column; 
      gap: 25px; 
      background: #fefefe;
    }
    
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-wrap: wrap;
      padding-bottom: 15px;
      border-bottom: 2px solid #ffeeba;
      position: relative;
      z-index: 1200; /* keep header above other content */
    }

    /* Header controls (notification bell, avatar) */
    .header-controls {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-left: 12px;
      position: relative;
      z-index: 1300; /* ensure controls are clickable */
    }

    .icon-button {
      background: transparent;
      border: none;
      cursor: pointer;
      position: relative;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.18s ease, transform 0.12s ease;
      color: #dc3545;
      font-size: 18px;
      z-index: 1301;
    }

    .icon-button:hover { background: rgba(220,53,69,0.06); transform: translateY(-2px); }

    .notif-badge {
      display: none;
      position: absolute;
      top: 4px;
      right: 4px;
      background: #dc3545;
      color: #fff;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    /* Small totals spinner (shown while fetching totals) */
    #totalsSpinner {
      display: none;
      width: 26px;
      height: 26px;
      border: 3px solid rgba(255,255,255,0.25);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      margin-left: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .header-title h1 {
      color: #dc3545;
      font-size: 24px;
      font-weight: 700;
    }
    
    .header-title p {
      color: #6c757d;
      font-size: 14px;
    }
    
    .search-bar { 
      position: relative;
      width: 300px; 
    }
    
    .search-bar input { 
      padding: 12px 20px 12px 45px; 
      border-radius: 50px; 
      border: 1px solid #dc3545; 
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.984); 
      background-color: #fff; 
      width: 100%; 
      font-size: 14px;
    }
    
    .search-bar i {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: #dc3545;
    }
    
    .menu-toggle { 
      display: none; 
      font-size: 24px; 
      background: none; 
      border: none; 
      cursor: pointer; 
      color: #dc3545; 
      position: absolute; 
      top: 20px; 
      left: 20px; 
      z-index: 1000; 
    }
    
    .student-profile { 
      background: #fff; 
      border-radius: 15px; 
      padding: 20px; 
      display: flex; 
      gap: 20px; 
      align-items: center; 
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.952); 
      border: 1px solid #ffeeba;
      margin-top: 10px;
    }
    
    .profile-pic { 
      width: 80px; 
      height: 80px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 3px solid #dc3545; 
    }
    
    .profile-details { 
      flex: 1; 
      min-width: 200px; 
    }
    
    .profile-details h3 { 
      margin-bottom: 8px; 
      color: #dc3545; 
      font-size: 18px;
    }
    
    .profile-details p { 
      margin: 4px 0; 
      font-size: 14px; 
      color: #495057; 
    }
    
    .welcome-banner { 
      background: linear-gradient(135deg, #dc3545, #fd7e14); 
      color: white; 
      border-radius: 15px; 
      padding: 25px 30px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      animation: slideIn 0.8s ease-in-out; 
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.968);
    }
    
    .welcome-banner img { 
      width: 80px; 
      border-radius: 10px; 
      border: 2px solid #ffeb3b;
    }
    
    @keyframes slideIn { 
      from { transform: translateX(-30px); opacity: 0; } 
      to { transform: translateX(0); opacity: 1; } 
    }
    
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 20px; 
    }
    
    /* Payment progress bar styles */
    .progress-container {
      margin-top: 18px;
      background: #fff;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid #ffeeba;
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }

    .progress-label { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px; }
    .progress-label .title { font-weight:700; color:#495057; }
    .progress-label .percent { font-weight:700; color:#6c757d; }

    .progress-bar { width:100%; height:18px; background:#f1f3f5; border-radius:10px; overflow:hidden; border:1px solid #ececec; }
    .progress-bar > .progress-fill { height:100%; width:0%; background:linear-gradient(90deg,#ffc107,#198754); transition:width 400ms ease, background 300ms ease; }
    .progress-bar.eligible > .progress-fill { background: linear-gradient(90deg,#28a745,#198754); }
    .progress-bar.not-eligible > .progress-fill { background: linear-gradient(90deg,#ff6b6b,#ff8c69); }
    .stat-card { 
      background: white; 
      border-radius: 15px; 
      padding: 25px; 
      text-align: center; 
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.966); 
      transition: transform 0.3s ease; 
      border-top: 4px solid;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: currentColor;
    }
    
    .stat-card:nth-child(1) { border-color: #dc3545; color: #dc3545; }
    .stat-card:nth-child(2) { border-color: #198754; color: #198754; }
    .stat-card:nth-child(3) { border-color: #ffc107; color: #ffc107; }
    
    .stat-card:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.959);
    }
    
    .stat-card i { 
      font-size: 32px; 
      margin-bottom: 15px; 
      display: block;
    }
    
    .stat-card h3 { 
      font-size: 24px; 
      margin-bottom: 5px; 
    }
    
    .stat-card p { 
      color: #6c757d; 
      font-size: 14px; 
      font-weight: 500;
    }
    
    .payment-section { 
      margin-top: 10px;
    }
    
    .payment-section h3 { 
      margin-bottom: 15px; 
      color: #dc3545;
      font-size: 20px;
    }
    
    .payment-grid { 
      display: grid; 
      grid-template-columns: repeat(2, 1fr); 
      gap: 20px; 
    }
    
    .payment-card { 
      background: white; 
      color: #495057; 
      padding: 25px; 
      border-radius: 15px; 
      text-align: center; 
      display: flex; 
      flex-direction: column; 
      justify-content: space-between; 
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.997); 
      border: 1px solid #ffeeba;
      transition: all 0.3s ease;
    }
    
    .payment-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.993);
    }
    
    .payment-card i { 
      font-size: 32px; 
      margin-bottom: 15px; 
      color: #dc3545;
    }
    
    .payment-card p { 
      margin: 10px 0; 
      font-weight: bold; 
      font-size: 16px;
    }
    
    .payment-card button { 
      margin-top: 15px; 
      padding: 12px; 
      background: #dc3545; 
      color: white;
      border: none; 
      border-radius: 8px; 
      font-weight: bold; 
      cursor: pointer; 
      transition: background 0.3s; 
      font-size: 14px;
    }
    
    .payment-card button:hover { 
      background: #c82333; 
    }
    
    .manual-receipt { 
      margin-top: 15px; 
      text-align: center;
    }
    
    .manual-receipt a { 
      color: #dc3545; 
      text-decoration: underline; 
      font-size: 14px;
    }
    
    .manual-receipt a:hover { 
      color: #c82333;
    }
    
    .pending-badge { 
      display: inline-block;
      margin-left: 8px; 
      background: #ffc107; 
      color: #212529; 
      padding: 3px 10px; 
      border-radius: 12px; 
      font-size: 12px; 
      font-weight: 600;
    }
    
    .register-card { 
      margin-top: 20px; 
      background: linear-gradient(135deg, #198754, #20c997); 
      padding: 25px; 
      border-radius: 15px; 
      text-align: center; 
      color: white; 
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.997);
    }
    
    .register-card p { 
      margin-bottom: 15px; 
      font-size: 18px;
      font-weight: 600;
    }
    
    .register-card button { 
      background: white; 
      color: #198754; 
      padding: 12px 25px; 
      border: none; 
      border-radius: 8px; 
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.3s; 
      font-size: 16px;
    }
    
    .register-card button:hover { 
      background: #f8f9fa; 
      transform: translateY(-2px);
    }
    
    .support-btn { 
      position: fixed; 
      bottom: 25px; 
      right: 25px; 
      background: #dc3545; 
      color: white; 
      font-size: 22px; 
      padding: 14px 18px; 
      border-radius: 50%; 
      text-decoration: none; 
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.984); 
      transition: transform 0.3s; 
      z-index: 100;
    }
    
    .support-btn:hover { 
      transform: scale(1.1); 
      background: #c82333;
    }
    
    footer { 
      margin-top: 40px; 
      text-align: center; 
      color: #6c757d; 
      font-size: 14px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
    }
    
    footer a { 
      color: #dc3545; 
      text-decoration: none; 
      font-weight: 500;
    }
    
    footer a:hover { 
      color: #c82333;
      text-decoration: underline;
    }
    
    /* Modal styles */
    .modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.7); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 2000; 
      animation: fadeIn 0.3s ease-in-out; 
    }
    
    .modal.show { 
      display: flex; 
      animation: fadeIn 0.6s ease-out forwards; 
    }
    
    .modal-content { 
      background: #fff; 
      padding: 25px 30px; 
      border-radius: 16px; 
      max-width: 500px; 
      width: 90%; 
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.999); 
      animation: scaleUp 0.3s ease-in-out; 
      position: relative; 
      text-align: left; 
      border-top: 4px solid #dc3545;
    }

    /* Make modal content scrollable when content is tall (useful for long forms) */
    .modal .modal-content {
      max-height: 85vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Opt-out animation helper: when present on a modal, disable entry/scale animations */
    .modal.no-animation { animation: none !important; }
    .modal.no-animation .modal-content { animation: none !important; opacity: 1 !important; }

    /* Lightweight scrollbar styles */
    .modal .modal-content::-webkit-scrollbar { width: 10px; }
    .modal .modal-content::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 8px; }
    .modal .modal-content::-webkit-scrollbar-track { background: transparent; }
    /* Firefox */
    .modal .modal-content { scrollbar-width: thin; scrollbar-color: rgba(0,0,0,0.12) transparent; }
    
    @keyframes scaleUp { 
      0% { transform: scale(0.9); opacity: 0; } 
      100% { transform: scale(1); opacity: 1; } 
    }
    
    .modal h3 { 
      margin-top: 0; 
      color: #dc3545; 
      font-size: 22px; 
      font-weight: 700; 
      margin-bottom: 15px;
    }
    
    .modal p { 
      color: #495057; 
      font-size: 15px; 
      margin: 12px 0; 
      line-height: 1.5;
    }
    
    .fee-option { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: #f8f9fa; 
      padding: 12px 15px; 
      margin: 10px 0; 
      border-radius: 8px; 
      font-size: 15px; 
      border-left: 3px solid #dc3545;
    }
    
    .fee-option input { 
      transform: scale(1.2); 
    }
    
    .confirm-btn { 
      margin-top: 20px;
      background: linear-gradient(90deg,#ff416c,#ff6b6b);
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease, opacity 160ms ease;
      font-weight: 700;
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(255,107,107,0.14);
    }

    .confirm-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(255,107,107,0.18); }
    .confirm-btn:active { transform: translateY(-1px); }
    .confirm-btn[disabled] { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Secondary button (ghost) */
    .btn-secondary {
      background: transparent;
      color: #495057;
      border: 1px solid #dee2e6;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 160ms ease, transform 120ms ease;
    }
    .btn-secondary:hover { background: #f8f9fa; transform: translateY(-2px); }

    /* Password input with toggle */
    .pwd-row { display:flex; gap:10px; align-items:center; }
    .pwd-input { position: relative; flex:1; }
    .pwd-input input { width:100%; padding-right:44px; }
    .pwd-toggle {
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      background:transparent; border:none; cursor:pointer; font-size:16px; color:#6c757d; padding:6px; border-radius:6px;
    }
    .pwd-toggle:focus { outline:2px solid rgba(220,53,69,0.15); }

    /* Rule valid/invalid states */
    .pwd-rule { display:flex; gap:8px; align-items:center; color:#6c757d; }
    .pwd-rule.valid { color: #198754; font-weight:700; }
    .pwd-rule.invalid { color: #6c757d; }

    /* Strength meter */
    .pwd-strength { height:8px; background:#e9ecef; border-radius:8px; overflow:hidden; margin-top:8px; }
    .pwd-strength > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#ffc107,#198754); transition:width 220ms ease; }
    
    .close-btn { 
      position: absolute; 
      top: 15px; 
      right: 20px; 
      font-size: 24px; 
      background: none; 
      border: none; 
      cursor: pointer; 
      color: #6c757d; 
      transition: color 0.2s ease; 
    }
    
    .close-btn:hover { 
      color: #dc3545; 
    }

    /* Notification modal - polished style */
    #notificationModal .modal-content {
      max-width: 560px;
      width: 92%;
      padding: 0;
      overflow: hidden;
      border-top: 6px solid #ff6a00;
    }

    #notificationModal .notif-header {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 18px 20px;
      background: linear-gradient(90deg, rgba(255,106,0,0.06), rgba(220,53,69,0.02));
      border-bottom: 1px solid #f1f1f1;
    }

    #notificationModal .notif-icon {
      width: 48px; height: 48px; border-radius: 10px; display:flex;align-items:center;justify-content:center;
      background: #ff6a00; color: white; font-size:18px; flex-shrink:0;
    }

    #notificationModal .notif-title { font-weight:700; color:#222; font-size:16px; }
    #notificationModal .notif-ts { font-size:12px; color:#6c757d; margin-top:4px; }

    #notificationModal .notif-body { padding:18px 20px; background: #fff; color:#333; line-height:1.5; white-space:pre-wrap; overflow:auto; max-height:54vh; }

    /* Small scroll controls inside the notification modal */
    #notificationModal .notif-scroll-controls { display:flex; gap:8px; justify-content:flex-end; padding:8px 14px 0 14px; }
    #notificationModal .notif-scroll-controls button { background:#e9ecef;border:1px solid #ddd;padding:6px 10px;border-radius:6px;cursor:pointer;color:#333;font-size:13px }
    #notificationModal .notif-scroll-controls button:disabled { opacity:0.5; cursor:default }

    #notificationModal .notif-footer { padding:12px 18px; display:flex; justify-content:flex-end; gap:10px; background:#fafafa; border-top:1px solid #f1f1f1; }

    #notificationModal .btn { padding:10px 16px; border-radius:8px; }

    /* Profile blocker styles */
    #profileBlocker { display: none; }

    /* Can't update modal */
    #cannotUpdateModal .modal-content { max-width: 420px; }
    #cannotUpdateModal .modal-content h3 { color: #dc3545; }

    
    /* Form styles */
    .form-group { 
      margin-bottom: 18px; 
    }
    
    .form-group label { 
      display: block; 
      margin-bottom: 6px; 
      font-weight: 600; 
      color: #495057; 
      font-size: 14px;
    }
    
    .form-group input, 
    .form-group select { 
      width: 100%; 
      padding: 12px 15px; 
      border: 1px solid #ced4da; 
      border-radius: 8px; 
      font-size: 15px; 
      transition: border 0.3s;
    }
    
    .form-group input:focus, 
    .form-group select:focus { 
      border-color: #dc3545; 
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.992);
    }
    
    .required:after { 
      content: " *"; 
      color: #dc3545; 
    }
    
    /* Toast notifications */
    #toastContainer { 
      position: fixed; 
      top: 20px; 
      right: 20px; 
      z-index: 99999; 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
      pointer-events: none; 
    }
    
    .toast { 
      pointer-events: auto; 
      min-width: 250px; 
      max-width: 400px; 
      background: #fff; 
      color: #495057; 
      padding: 14px 16px; 
      border-radius: 10px; 
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.996); 
      font-size: 14px; 
      line-height: 1.4; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      border-left: 4px solid;
    }
    
    .toast--success { 
      border-color: #198754; 
    }
    
    .toast--error { 
      border-color: #dc3545; 
    }
    
    .toast .toast-close { 
      margin-left: auto; 
      background: transparent; 
      border: none; 
      font-size: 16px; 
      color: #6c757d; 
      cursor: pointer; 
    }

    /* Top-right corner ephemeral modal */
    .corner-modal {
      position: fixed;
      top: 18px;
      right: 18px;
      z-index: 100000;
      background: linear-gradient(90deg, #28a745, #198754);
      color: #fff;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.18);
      display: flex;
      gap: 10px;
      align-items: center;
      max-width: 360px;
      font-weight: 600;
    }

    .corner-modal .corner-icon { font-size: 18px; }
    .corner-modal .corner-text { flex:1; font-size:14px; }
    .corner-modal .corner-close { background: transparent; border: none; color: rgba(255,255,255,0.9); font-size: 18px; cursor: pointer; }
    
    /* Payment History */
    .history-btn { 
      position: fixed; 
      bottom: 25px; 
      left: 25px; 
      background: #dc3545; 
      color: white; 
      padding: 12px 20px; 
      border-radius: 8px; 
      border: none; 
      cursor: pointer; 
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
      transition: all 0.3s;
      z-index: 100;
    }
    
    .history-btn:hover { 
      background: #c82333; 
      transform: translateY(-2px);
    }
    
    #historyModal .modal-content {
      max-width: 900px;
    }
    
    .history-search {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .history-search input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid #ced4da;
    }
    
    .history-search button {
      padding: 10px 15px;
      border-radius: 8px;
      background: #6c757d;
      color: white;
      border: none;
      cursor: pointer;
    }
    
    .history-table-container {
      max-height: 60vh;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: white; 
    }
    
    th, td { 
      padding: 12px 15px; 
      border-bottom: 1px solid #dee2e6; 
      text-align: left; 
    }
    
    th { 
      background: #f8f9fa; 
      font-weight: 600;
      color: #495057;
      position: sticky;
      top: 0;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .action-btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      margin-right: 5px;
    }
    
    .view-btn {
      background: #dc3545;
      color: white;
    }
    
    .pdf-btn {
      background: #198754;
      color: white;
    }
    
    /* Responsive styles */
    @media (max-width: 1100px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .payment-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 900px) {
      .container { 
        grid-template-columns: 1fr; 
      }
      
      .sidebar { 
        display: none; 
      }
      
      /* Mobile: full-screen pop-up menu that animates from the menu button */
      .sidebar.mobile {
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2200;
        padding: 80px 20px 30px 20px; /* leave space for the toggle button */
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        background: linear-gradient(180deg, #d63384, #dc3545);
        align-items: center;
        justify-content: flex-start;
        gap: 16px;
        transform-origin: 28px 28px; /* animate from the menu button */
        transform: scale(0.92);
        opacity: 0;
        animation: mobilePopIn 260ms cubic-bezier(.2,.9,.2,1) forwards;
      }

      @keyframes mobilePopIn {
        0% { transform: scale(0.78); opacity: 0; }
        60% { transform: scale(1.02); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
      }

      /* Larger tappable links for mobile full-screen menu */
      .sidebar.mobile a {
        font-size: 20px;
        padding: 16px 28px;
        width: 100%;
        justify-content: flex-start;
        border-left: none;
        text-align: left;
      }

      /* Close button inside the mobile menu */
      .sidebar .mobile-close {
        position: absolute;
        top: 18px;
        right: 18px;
        background: rgba(255,255,255,0.12);
        color: white;
        border: none;
        font-size: 28px;
        width: 44px;
        height: 44px;
        border-radius: 8px;
        cursor: pointer;
        display: none; /* shown only on mobile */
        align-items: center;
        justify-content: center;
      }

      .sidebar.mobile .mobile-close { display: flex; }
      
      .menu-toggle { 
        display: block; 
        z-index: 1000;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .search-bar {
        width: 100%;
        margin-top: 15px;
      }
    }
    
    @media (max-width: 600px) {
      .main { 
        padding: 20px 15px; 
      }
      
      .header { 
        flex-direction: column; 
        align-items: flex-start;
      }
      
      .student-profile { 
        flex-direction: column; 
        align-items: flex-start; 
        text-align: left; 
      }
      
      .welcome-banner { 
        flex-direction: column; 
        text-align: center; 
        padding: 20px; 
        gap: 20px; 
      }
      
      .welcome-banner img { 
        width: 70px; 
      }
      
      .modal-content {
        padding: 20px;
      }
      
      .history-table-container {
        font-size: 14px;
      }
      
      th, td {
        padding: 8px 10px;
      }
      
      footer { 
        font-size: 13px; 
      }
    }


    /* Add to your CSS */
.btn-login {
  position: relative;
  overflow: hidden;
  transition: all 0.3s;
}

.ripple {
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.6);
  transform: scale(0);
  animation: ripple-animation 0.6s linear;
  pointer-events: none;
}

@keyframes ripple-animation {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

/* Button hover effects */
.btn-login:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
}

.btn-login:active {
  transform: translateY(-1px);
}


/* Add to your CSS */
.container {
  animation: slideUp 0.8s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.right-section {
  animation: slideInRight 0.8s ease-out 0.3s both;
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.left-section {
  animation: slideInLeft 0.8s ease-out 0.3s both;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}


/* Add to your CSS */
.input-with-icon {
  position: relative;
}

.input-with-icon input:focus ~ .floating-label,
.input-with-icon input:not(:placeholder-shown) ~ .floating-label {
  top: -8px;
  left: 45px;
  font-size: 12px;
  color: var(--primary);
  background: white;
  padding: 0 8px;
}

.floating-label {
  position: absolute;
  left: 45px;
  top: 50%;
  transform: translateY(-50%);
  color: #999;
  transition: all 0.3s ease;
  pointer-events: none;
  background: white;
}

/* Input shake animation for errors */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-8px); }
  75% { transform: translateX(8px); }
}

.shake {
  animation: shake 0.4s ease-in-out;
}

/* Input glow effect */
.input-glow {
  box-shadow: 0 0 15px rgba(67, 97, 238, 0.3);
  transition: box-shadow 0.3s ease;
}


/* Add to your CSS */
.social-btn {
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  position: relative;
  overflow: hidden;
}

.social-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.social-btn:hover::before {
  left: 100%;
}

.social-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}


/* Add to your CSS */
.feature {
  transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
  transform-style: preserve-3d;
}

.feature:hover {
  transform: translateY(-10px) scale(1.02);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.feature i {
  transition: transform 0.3s ease;
}

.feature:hover i {
  transform: scale(1.2) rotate(5deg);
}


/* Add to your CSS */
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.loading-content img {
  animation: float 3s ease-in-out infinite;
}

@keyframes typewriter {
  from { width: 0; }
  to { width: 100%; }
}

.typewriter {
  overflow: hidden;
  border-right: 2px solid white;
  white-space: nowrap;
  animation: typewriter 2s steps(40) 1s both;
}



/* Add to your CSS */
@keyframes pulse-glow {
  0% {
    box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(67, 97, 238, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(67, 97, 238, 0);
  }
}

.pulse-glow {
  animation: pulse-glow 2s infinite;
}

/* Apply to login button */
.btn-login {
  animation: pulse-glow 2s infinite;
}



/* Add to your CSS */
.page-transition {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--gradient);
  z-index: 9999;
  transform: translateY(100%);
}

.page-transition.slide-up {
  animation: slideUpTransition 0.8s ease-in-out forwards;
}

@keyframes slideUpTransition {
  to {
    transform: translateY(-100%);
  }
}



   /* Support Chat Modal Styles */
    .support-chat-modal {
      position: fixed;
      bottom: 90px;
      right: 25px;
      width: 350px;
      height: 500px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.968);
      z-index: 2000;
      display: none;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #ffeeba;
    }
    
    .support-chat-modal.active {
      display: flex;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .chat-header {
      background: linear-gradient(135deg, #dc3545, #fd7e14);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .chat-header h3 {
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-chat {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    
    .chat-body {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message {
      max-width: 85%;
      padding: 10px 15px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .bot-message {
      background: #f1f1f1;
      color: #333;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }
    
    .user-message {
      background: #dc3545;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    
    .options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 5px;
    }
    
    .option-btn {
      background: white;
      border: 1px solid #dc3545;
      color: #dc3545;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      text-align: left;
      transition: all 0.2s;
    }
    
    .option-btn:hover {
      background: #dc3545;
      color: white;
    }
    
    .chat-input {
      padding: 15px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }
    
    .chat-input button {
      background: #dc3545;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .whatsapp-btn {
      background: #25D366;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      margin-top: 10px;
      justify-content: center;
    }
    
    .whatsapp-btn:hover {
      background: #128C7E;
    }
    
    @media (max-width: 600px) {
      .support-chat-modal {
        width: 90vw;
        height: 70vh;
        right: 5vw;
        bottom: 80px;
      }
    }



  </style>
  <style>
    /* Settings-related utility classes */
    body.theme-dark { background: #0f1720; color: #e6eef8; }
    body.theme-dark .container { background: #071024; border-color: rgba(255,255,255,0.03); }
    body.theme-dark .sidebar { background: linear-gradient(180deg,#0b1220,#111827); color: #fff; }
    body.theme-dark .main { background: #071024; }
    body.compact .main { padding: 12px 14px; gap: 12px; }
    body.compact .student-profile { padding: 12px; gap: 12px; }
    body.hide-avatar .profile-pic { display: none; }
    body.small-font { font-size: 14px; }
    .sidebar.collapsed { width: 72px; }
    .sidebar.collapsed a { text-indent: -9999px; white-space: nowrap; overflow: hidden; }
    .sidebar.collapsed a i { margin-right: 0; }
    /* Simple dark modal adjustments */
    body.theme-dark .modal-content { background: #071024; color: #e6eef8; border-top-color: #ff6a00; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Profile onboarding removed: blocker omitted -->
    <button type="button" class="menu-toggle" onclick="(typeof openMobileNav==='function'?openMobileNav():document.querySelector('.sidebar').classList.toggle('mobile'))" aria-label="Open menu">☰</button>
    
    <div class="sidebar" role="navigation" aria-label="Primary navigation">
      <div style="padding: 0 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.2); width: 100%; position:relative;">
        <h2 style="color: #ffeb3b; font-size: 20px; display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-graduation-cap"></i> GH Technical University
        </h2>
        <!-- Mobile close button (visible only when .mobile is active) -->
        <button class="mobile-close" onclick="closeMobileNav()" aria-label="Close menu">&times;</button>
      </div>
      <a href="#" class="active" data-info="dashboard"><i class="fas fa-home"></i> Dashboard</a>
      <a href="#" data-info="payment"><i class="fas fa-credit-card"></i> Payment</a>
      <a href="#" data-info="register"><i class="fas fa-clipboard-check"></i> Register</a>
      <a href="#" id="resultsLink" data-info="results"><i class="fas fa-chart-line"></i> Results</a>
      <a href="#" data-info="blog"><i class="fas fa-blog"></i> Blog</a>
      <a href="#" data-info="calendar"><i class="fas fa-calendar-alt"></i> Calendar</a>
      <a href="#" data-info="profile"><i class="fas fa-user"></i> Profile</a>
      <a href="#" data-info="support"><i class="fas fa-headset"></i> Support</a>
      <a href="#" data-info="settings"><i class="fas fa-cog"></i> Settings</a>
      <a href="#" data-info="logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="main">
      <div class="header">
        <div class="header-title">
          <h1 style="margin-left: 50px;">Student Dashboard</h1>
          <p>Welcome back! Manage your academic journey</p>
        </div>
        
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input id="searchInput" type="text" placeholder="Search students or payments..." />
        </div>
        <div class="header-controls">
          <button id="notifBell" class="icon-button" title="Notifications" aria-label="Notifications">
            <i class="fas fa-bell"></i>
            <span id="notifBadge" class="notif-badge">!</span>
          </button>
          <div id="totalsSpinner" title="Updating totals" aria-hidden="true"></div>
          <!-- optional avatar or profile quick actions -->
            <button id="profileBtn" class="icon-button" title="Profile" aria-label="Profile">
              <i class="fas fa-user-circle"></i>
            </button>
        </div>
      </div>

      <div class="student-profile">
        <img id="profilePic" src="images/AVATAR.png" alt="Student Profile" class="profile-pic" />
        <div class="profile-details">
          <h3 id="student-name">Loading Name...</h3>
          <p><strong>ID:</strong> <span id="student-id">...</span></p>
          <p><strong>Level:</strong> <span id="student-level">...</span></p>
          <p><strong>Department:</strong> <span id="student-department">...</span></p>
          
            <p><i class="fas fa-envelope" style="color: #dc3545;"></i> <span id="student-email">...</span></p>
        </div>
      </div>

      <div class="welcome-banner">
        <div>
          <h2>GH TECHNICAL UNIVERSITY COLLEGE</h2>
          <p id="welcome-message">Hello, You are warmly welcome back to school! Enjoy your semester</p>
        </div>
        <img src="images/favicon.png" alt="Logo" />
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <i class="fas fa-wallet"></i>
          <h3 id="totalPayable">GHS 2700.00</h3>
          <p>Total Payable</p>
        </div>
        <div class="stat-card">
          <i class="fas fa-money-bill-wave"></i>
          <h3 id="totalPaid">GHS 0.00</h3>
          <p>Total Paid</p>
        </div>
        <div class="stat-card">
          <i class="fas fa-exclamation-circle"></i>
          <h3 id="outstandingBalance">GHS 2700.00</h3>
          <p>Outstanding Balance</p>
        </div>
      </div>

      <div class="payment-section">
        <h3>Make Payment</h3>
        <div class="payment-grid">
          <div class="payment-card">
            <i class="fas fa-graduation-cap"></i>
            <p>Tuition Fee</p>
            <button id="payTuitionBtn" onclick="openTuitionModal()">Pay Tuition</button>
          </div>
          <div class="payment-card">
            <i class="fas fa-file-invoice-dollar"></i>
            <p>Other Fees</p>
            <button id="showOtherFeesBtn" onclick="openOtherFeesModal()">Other Fees</button>
          </div>
        </div>
        
        <!-- Manual receipt upload removed per request -->
      </div>

      <div class="register-card">
        <p>Ready to Register?</p>
        <button id="registerCoursesBtn" onclick="registerCourses()">Register Courses</button>
      </div>
    </div>
  </div>

  <!-- Student account setup removed from dashboard -->

    <!-- Info Modal for sidebar links -->
    <div class="modal" id="infoModal" onclick="closeIfBackdrop(event)" aria-hidden="true">
      <div class="modal-content">
        <button class="close-btn" onclick="toggleModal('infoModal')" aria-label="Close">&times;</button>
        <h3 id="infoModalTitle">Information</h3>
        <div id="infoModalBody">
          <p style="color:#666;margin:0;">Select a sidebar item to learn more about what you can do there.</p>
        </div>
        <div style="text-align:right;margin-top:12px;">
          <button class="confirm-btn" onclick="toggleModal('infoModal')">Close</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        // Lightweight mapping of sidebar keys => title & description
        const INFO_MAP = {
          dashboard: { title: 'Dashboard Overview', desc: 'Overview of your account — balances, quick links to payments, registration, and recent notifications.' },
          payment: { title: 'Payments', desc: 'Pay tuition and other fees securely. You can use the online payment gateway or upload manual receipts which are processed automatically.' },
          register: { title: 'Course Registration', desc: 'Register for courses for the current semester. Registration opens after required fees are paid.' },
          results: { title: 'Results', desc: 'View your exam and coursework results, grades, and downloadable transcripts.' },
          blog: { title: 'News & Blog', desc: 'Read university announcements, news, and student stories.' },
          calendar: { title: 'Academic Calendar', desc: 'See important dates, exam schedules, registration deadlines, and school events.' },
          profile: { title: 'Profile', desc: 'View and update your personal information, contact details, and emergency contacts.' },
          support: { title: 'Student Support', desc: 'Open the support chat or submit a help request to contact administrators and support staff.' },
          settings: { title: 'Settings', desc: 'Manage your dashboard preferences, notification settings, and security options.' },
          logout: { title: 'Logout', desc: 'Sign out from the dashboard. Make sure you have saved any changes before logging out.' }
        };

        const infoModal = document.getElementById('infoModal');
        const infoTitle = document.getElementById('infoModalTitle');
        const infoBody = document.getElementById('infoModalBody');

        function showInfo(key){
          // Special-case: open settings modal instead of the info modal
          if(key === 'settings'){ toggleModal('settingsModal'); return; }
          // Open registration modal instead of generic info when Register is clicked
          if(key === 'register'){ try{ if(window.openCourseRegister) { window.openCourseRegister(); return; } }catch(e){} }

          const entry = INFO_MAP[key] || { title: key || 'Info', desc: 'No additional information available.' };
          if(infoTitle) infoTitle.textContent = entry.title;
          if(infoBody) infoBody.textContent = entry.desc;
          if(infoModal){ infoModal.classList.add('show'); infoModal.style.display = 'flex'; }
        }
        // Expose for other scripts and delegated handlers
        try{ window.showInfo = showInfo; }catch(e){ /* ignore */ }

        // Settings persistence and application
        const SETTINGS_KEY = 'dashboardSettings_v1';

        function defaultSettings(){
          return {
            theme: 'light', // 'light' | 'dark'
            compact: false,
            hideAvatar: false,
            fontSize: 'normal', // 'normal'|'small'
            notifications: true
          };
        }

        function loadSettings(){
          try{
            const raw = localStorage.getItem(SETTINGS_KEY);
            const s = raw ? JSON.parse(raw) : defaultSettings();
            applySettings(s);
            return s;
          }catch(e){ console.warn('Could not load settings', e); const s = defaultSettings(); applySettings(s); return s; }
        }

        function saveSettings(s){
          try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); applySettings(s); showToast('Settings saved'); }catch(e){ console.error('saveSettings', e); showToast('Could not save settings', 'error'); }
        }

        function applySettings(s){
          const body = document.body;
          if(!s) s = defaultSettings();

          // Theme
          if(s.theme === 'dark') body.classList.add('theme-dark'); else body.classList.remove('theme-dark');

          // Compact layout
          if(s.compact) body.classList.add('compact'); else body.classList.remove('compact');

          // Hide avatar
          if(s.hideAvatar) body.classList.add('hide-avatar'); else body.classList.remove('hide-avatar');

          // Font size
          if(s.fontSize === 'small') document.documentElement.style.fontSize = '14px'; else document.documentElement.style.fontSize = '';

          // Notifications (basic: hide the bell if disabled)
          const notifBtn = document.getElementById('notifBell');
          if(notifBtn) notifBtn.style.display = s.notifications ? '' : 'none';
        }

        function openSettingsModalAndPopulate(){
          const s = loadSettings();
          // populate controls
          const themeEl = document.getElementById('settingTheme');
          const compactEl = document.getElementById('settingCompact');
          const hideAvatarEl = document.getElementById('settingHideAvatar');
          const fontSizeEl = document.getElementById('settingFontSize');
          const notifyEl = document.getElementById('settingNotifications');
          if(themeEl) themeEl.value = s.theme || 'light';
          if(compactEl) compactEl.checked = !!s.compact;
          if(hideAvatarEl) hideAvatarEl.checked = !!s.hideAvatar;
          if(fontSizeEl) fontSizeEl.value = s.fontSize || 'normal';
          if(notifyEl) notifyEl.checked = !!s.notifications;
          toggleModal('settingsModal');
        }

        // Attach to every sidebar link
        document.addEventListener('DOMContentLoaded', function(){
          // Use delegated handler on the sidebar so it works reliably on mobile (single listener)
          const sidebarEl = document.querySelector('.sidebar');
          if(sidebarEl){
            const sidebarClickHandler = function(ev){
              const a = ev.target.closest && ev.target.closest('a');
              if(!a) return;
              ev.preventDefault();
              const key = a.getAttribute('data-info') || (a.textContent || '').trim().toLowerCase().split(/\s+/)[0];
              try{ showInfo(key); }catch(e){ try{ toggleModal('infoModal'); }catch(_){ /* ignore */ } }
              // If mobile menu is open, close it after selection
              try{ if(sidebarEl.classList.contains('mobile')) sidebarEl.classList.remove('mobile'); }catch(e){}
            };
            sidebarEl.addEventListener('click', sidebarClickHandler);
            sidebarEl.addEventListener('touchstart', sidebarClickHandler, { passive: true });
          }

          // Wire settings modal buttons
          const saveBtn = document.getElementById('saveSettingsBtn');
          const cancelBtn = document.getElementById('cancelSettingsBtn');
          if(saveBtn){
            saveBtn.addEventListener('click', function(){
              const s = {
                theme: document.getElementById('settingTheme')?.value || 'light',
                compact: !!document.getElementById('settingCompact')?.checked,
                hideAvatar: !!document.getElementById('settingHideAvatar')?.checked,
                fontSize: document.getElementById('settingFontSize')?.value || 'normal',
                notifications: !!document.getElementById('settingNotifications')?.checked
              };
              saveSettings(s);
              toggleModal('settingsModal');
            });
          }
          if(cancelBtn){ cancelBtn.addEventListener('click', function(){ toggleModal('settingsModal'); }); }

          // initialize settings on load
          loadSettings();
        });

        // Expose a function for other code to open settings modal
        window.openSettings = openSettingsModalAndPopulate;
      })();
    </script>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal" onclick="closeIfBackdrop(event)">
      <div class="modal-content">
        <button class="close-btn" onclick="toggleModal('settingsModal')" aria-label="Close">&times;</button>
        <h3>Dashboard Settings</h3>

        <div style="display:grid;gap:12px;margin-top:8px;">
          <div class="form-group">
            <label class="required">Theme</label>
            <select id="settingTheme">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>

          <div class="form-group">
            <label><input type="checkbox" id="settingCompact"> Compact layout (reduced spacing)</label>
          </div>

          <div class="form-group">
            <label><input type="checkbox" id="settingHideAvatar"> Hide profile avatar</label>
          </div>

          <div class="form-group">
            <label>Font Size</label>
            <select id="settingFontSize">
              <option value="normal">Normal</option>
              <option value="small">Small</option>
            </select>
          </div>

          <div class="form-group">
            <label><input type="checkbox" id="settingNotifications"> Enable notifications (show bell)</label>
          </div>

          <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn-secondary" id="cancelSettingsBtn">Cancel</button>
            <button class="confirm-btn" id="saveSettingsBtn">Save Settings</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal" id="notificationModal">
      <div class="modal-content">
        <button class="close-btn" onclick="hideNotificationModal()" aria-label="Close">&times;</button>

        <div class="notif-header">
          <div class="notif-icon"><i class="fas fa-bell"></i></div>
          <div style="flex:1;">
            <div class="notif-title">Message from Admin</div>
            <div class="notif-ts" id="notificationTimestamp"></div>
          </div>
        </div>

        <div class="notif-scroll-controls" aria-hidden="false">
          <button id="notifScrollTop" title="Scroll to top">↑ Top</button>
          <button id="notifScrollBottom" title="Scroll to bottom">↓ Bottom</button>
        </div>

        <div class="notif-body" id="notificationContent">
          <p style="color:#666;margin:0;">No notifications</p>
        </div>

        <div class="notif-footer">
          <button id="ackNotificationModalBtn" class="btn">Acknowledge</button>
          <button class="btn btn-secondary" onclick="hideNotificationModal()">Close</button>
        </div>
      </div>
    </div>

  <!-- Toast container for inline notifications -->
  <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <!-- Welcome Modal After Form Submission -->
  <div class="modal" id="welcomeModal">
    <div class="modal-content">
      <button class="close-btn" onclick="toggleModal('welcomeModal')">&times;</button>
      <h3>Welcome to GH Technical University!</h3>
      <p id="welcomeMessage">We're excited to have you join our academic community.</p>
      <button class="confirm-btn" onclick="toggleModal('welcomeModal')">Get Started</button>
    </div>
  </div>

  <!-- Tuition Modal -->
  <div class="modal" id="tuitionModal">
    <div class="modal-content">
      <button class="close-btn" onclick="toggleModal('tuitionModal')">&times;</button>
      <h3>Pay Tuition Fee</h3>
      <p>The full tuition fee for the semester is <strong style="color: #dc3545;">GHS 2,550.00</strong>.
      <br>You can pay either the full amount or at least <strong style="color: #dc3545;">80%</strong> (GHS 2,040.00) to begin your registration.</p>
      <div class="fee-option"><label><input type="radio" name="tuitionAmount" value="2040"> Pay 80% - GHS 2,040.00</label></div>
      <div class="fee-option"><label><input type="radio" name="tuitionAmount" value="2550"> Pay 100% - GHS 2,550.00</label></div>
      <button class="confirm-btn" onclick="payTuition()">Proceed to Pay</button>
    </div>
  </div>

  <!-- Other Fees Modal -->
  <div class="modal" id="otherFeesModal">
    <div class="modal-content">
      <button class="close-btn" onclick="toggleModal('otherFeesModal')">&times;</button>
      <h3>Select Other Fees to Pay</h3>
      <p>In addition to tuition, the following fees complete your registration:</p>
      <div class="fee-option">
        <label>
          <input type="checkbox" name="otherFee" value="SRC Dues|.1">
          <strong>SRC Dues</strong> – GHS 50.00
          <br><small style="color: #6c757d;">Supports student union and welfare activities.</small>
        </label>
      </div>
      <div class="fee-option">
        <label>
          <input type="checkbox" name="otherFee" value="Medical Dues|.10">
          <strong>Medical Dues</strong> – GHS 80.00
          <br><small style="color: #6c757d;">Covers basic healthcare and first aid services.</small>
        </label>
      </div>
      <div class="fee-option">
        <label>
          <input type="checkbox" name="otherFee" value="Departmental Dues|.1">
          <strong>Departmental Dues</strong> – GHS 50.00
          <br><small style="color: #6c757d;">For departmental resources and academic materials.</small>
        </label>
      </div>
      <button class="confirm-btn" onclick="payOtherFees()">Proceed to Pay</button>
    </div>
  </div>

  <!-- Restriction Modal (single instance) -->
  <div id="restrictionModal" class="modal">
    <div class="modal-content" style="text-align:center;">
      <button class="close-btn" onclick="toggleModal('restrictionModal')">&times;</button>
      <h3>Access Restricted</h3>
      <p>You must pay at least 50% of tuition and all other fees to register for courses.</p>
      <button class="confirm-btn" onclick="toggleModal('restrictionModal')">Close</button>
    </div>
  </div>

  <!-- Receipt Modal (content populated by receipt.js) -->
  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="toggleModal('receiptModal')">&times;</button>
      <div id="receiptContent"></div>
    </div>
  </div>

  <!-- Password reset removed per request -->

  <!-- Manual receipt upload removed -->


  <!-- Payment History Modal -->
  <div id="historyModal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="close-btn" onclick="toggleModal('historyModal')">&times;</button>
      <h3>Payment History</h3>
      <div class="history-search">
        <input id="historySearch" placeholder="Search by type, ref, or amount" />
        <button id="clearHistoryBtn">Clear</button>
      </div>
      <div class="history-table-container">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Fee Type</th>
              <th>Fee Breakdown</th>
              <th>Amount</th>
              <th>Receipt #</th>
              <th>Student</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="historyTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Quick button to open payment history -->
  <button class="history-btn" id="openHistoryBtn">
    View Payment History
  </button>

    <!-- Enhanced Support Chat Modal -->
  <div class="support-chat-modal" id="supportChatModal">
    <div class="chat-header">
      <h3><i class="fas fa-headset"></i> Student Support</h3>
      <button class="close-chat" id="closeChatBtn">&times;</button>
    </div>
    <div class="chat-body" id="chatBody">
      <!-- Chat messages will be dynamically added here -->
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Type your message...">
      <button id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <!-- Updated Support Button -->
  <button class="support-btn" id="supportBtn">
    <i class="fas fa-headset"></i>
  </button>

  <!-- JavaScript remains exactly the same as in the original -->
  <script type="module">
    // All the original JavaScript code goes here - unchanged
    // This would be the exact same JavaScript as in the original file
    // I'm not including it here for brevity, but it would be copied exactly as is


/* ===== Student Dashboard – Updated with Student Info Form ===== */

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/* ---------- Paystack ---------- */
const PAYSTACK_PUBLIC_KEY = 'pk_live_0563b84aae2c983dcbf04ec1fad441f04ef25d07';

/* ---------- Supabase ---------- */
const supabase = createClient(
  'https://fyriapqeztevzkcaaiqw.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5cmlhcHFlenRldnprY2FhaXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5OTgyNTcsImV4cCI6MjA3OTU3NDI1N30.Re3EZ2VXE6Z7qWhVlxV6yqqIWB8wj1b1wURNLZXpddY'
);

window.supabase = supabase;

/* ---------- Avatar upload (profile picture) ---------- */
const AVATAR_BUCKET = 'student-avatars';

async function uploadProfileAvatar(file){
  if(!file) return null;
  try{
    const sid = window.studentId || 'anon';
    const ext = (file.name || '').split('.').pop();
    const filename = `avatars/${sid}-${Date.now()}.${ext}`;
    // Upload file to storage bucket
    const { error: uploadError } = await supabase.storage.from(AVATAR_BUCKET).upload(filename, file, { upsert: true });
    if(uploadError){ console.warn('Avatar upload failed', uploadError); return null; }
    // Get public URL
    const { data: publicData } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(filename);
    const publicUrl = publicData && publicData.publicUrl;
    // Persist to students table if possible (best-effort)
    if(window.studentId){
      try{
        const { error: updErr } = await supabase.from('students').update({ avatar_url: publicUrl }).eq('id', window.studentId);
        if(updErr) console.debug('Could not update students.avatar_url (maybe column missing or RLS):', updErr);
      }catch(e){ console.debug('students update failed', e); }
    }
    try{ localStorage.setItem('studentAvatar', publicUrl); }catch(e){}
    const img = document.getElementById('profilePic'); if(img) img.src = publicUrl;
    return publicUrl;
  }catch(e){ console.warn('uploadProfileAvatar error', e); return null; }
}

function initAvatarUploader(){
  try{
    const img = document.getElementById('profilePic');
    if(!img) return;
    img.style.cursor = 'pointer';
    // Create (or reuse) a hidden file input
    let input = document.getElementById('profileFileInput');
    if(!input){
      input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.id = 'profileFileInput';
      input.style.display = 'none';
      document.body.appendChild(input);
    }
    img.addEventListener('click', ()=> input.click());
    input.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      // Optimistic preview
      try{
        const reader = new FileReader();
        reader.onload = ()=>{ const i = document.getElementById('profilePic'); if(i) i.src = reader.result; };
        reader.readAsDataURL(file);
      }catch(_){ }
      const url = await uploadProfileAvatar(file);
      if(url) showModalMessage && showModalMessage('Profile photo updated');
      // reset input
      try{ input.value = ''; }catch(e){}
    });
  }catch(e){ console.warn('initAvatarUploader failed', e); }
}

// Initialize when DOM is ready (module script might run before full DOM)
try{ if(document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(initAvatarUploader, 40); else document.addEventListener('DOMContentLoaded', initAvatarUploader); }catch(e){ setTimeout(initAvatarUploader, 120); }

// ---------- Announcements (student) ----------
async function fetchLatestAnnouncement(){
  try{
    const { data, error } = await supabase.from('notifications').select('*').order('created_at', { ascending: false }).limit(1);
    const contentEl = document.getElementById('notificationContent');
    const tsEl = document.getElementById('notificationTimestamp');
    const badge = document.getElementById('notifBadge');
    if (error) { console.warn('Error loading announcements', error); if(contentEl) contentEl.textContent = 'Could not load announcements'; return; }
    if (data && data.length > 0) {
      const n = data[0];
      if (contentEl) contentEl.innerHTML = n.message || n.title || 'No message';
      if (tsEl) tsEl.textContent = new Date(n.created_at).toLocaleString();
      if (badge) { badge.style.display = 'flex'; badge.textContent = '!'; }
      window.latestAnnouncement = n;
    } else {
      if (contentEl) contentEl.innerHTML = '<p style="color:#666;margin:0;">No notifications</p>';
      if (tsEl) tsEl.textContent = '';
      if (badge) badge.style.display = 'none';
    }
  }catch(e){ console.warn('fetchLatestAnnouncement', e); }
}

// Fetch full list of notifications (used for the bell list). Stores in window.notifications
async function fetchNotifications({ limit = 50 } = {}){
  try{
    const { data, error } = await supabase.from('notifications').select('*').order('created_at', { ascending: false }).limit(limit);
    if(error){ console.warn('Error loading notifications', error); return []; }
    window.notifications = data || [];
    renderNotificationsList(window.notifications);
    updateNotifBadgeFromList(window.notifications);
    return window.notifications;
  }catch(e){ console.warn('fetchNotifications', e); return []; }
}

function getReadNotificationIds(){
  try{
    const key = `readNotifications:${window.studentId || 'anon'}`;
    const raw = localStorage.getItem(key) || '[]';
    const arr = JSON.parse(raw || '[]');
    return new Set(arr || []);
  }catch(e){ return new Set(); }
}

function setReadNotificationIds(set){
  try{
    const key = `readNotifications:${window.studentId || 'anon'}`;
    const arr = Array.from(set || []);
    localStorage.setItem(key, JSON.stringify(arr));
  }catch(e){ }
}

function updateNotifBadgeFromList(list){
  try{
    const badge = document.getElementById('notifBadge'); if(!badge) return;
    const read = getReadNotificationIds();
    const unreadCount = (list || []).filter(n => !read.has(String(n.id))).length;
    if(unreadCount > 0){ badge.style.display = 'flex'; badge.textContent = String(unreadCount); window.studentNotificationUnread = true; }
    else { badge.style.display = 'none'; window.studentNotificationUnread = false; }
  }catch(e){ console.warn(e); }
}

function renderNotificationsList(list){
  try{
    const container = document.getElementById('notificationContent'); if(!container) return;
    const read = getReadNotificationIds();
    if(!list || list.length === 0){ container.innerHTML = '<p style="color:#666;margin:0;">No notifications</p>'; return; }
    // Helper: sanitize message by stripping HTML tags and preserving line breaks
    function sanitizeMessage(raw){
      try{
        if(!raw && raw !== 0) return '';
        // Use a DOM parser-safe method: assign to innerHTML then read textContent
        const tmp = document.createElement('div');
        tmp.innerHTML = String(raw || '');
        const text = (tmp.textContent || tmp.innerText || '').toString();
        // Escape and convert newlines to <br>
        return escapeHtml(text).replace(/\n/g, '<br>');
      }catch(e){ return escapeHtml(String(raw || '')).replace(/\n/g,'<br>'); }
    }

    const html = list.map(n => {
      const id = n.id || '';
      const ts = n.created_at ? new Date(n.created_at).toLocaleString() : '';
      const title = escapeHtml(n.title || 'Announcement');
      const msg = sanitizeMessage(n.message || '');
      const isRead = read.has(String(id));
      return `
        <div class="notif-item" data-id="${id}" style="border-bottom:1px solid #eee;padding:10px 0;display:flex;gap:12px;align-items:flex-start;">
          <div style="flex:1;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div><strong>${title}</strong><div style="font-size:12px;color:#666;margin-top:4px;">${ts}</div></div><div style="min-width:120px;text-align:right;"><button class="btn btn-secondary small mark-read" data-id="${id}" style="margin-right:6px;">${isRead? 'Mark Unread':'Mark Read'}</button><button class="btn small delete-notif" data-id="${id}" style="background:#ff4d4f;border:none;padding:6px 8px;border-radius:6px;color:#fff;">Delete</button></div></div>
            <div style="margin-top:8px;color:#333;">${msg}</div>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = html;

    // Wire actions (delegation)
    container.querySelectorAll('.mark-read').forEach(btn=>{
      btn.onclick = (e)=>{
        const id = btn.getAttribute('data-id'); toggleNotificationRead(id);
      };
    });
    container.querySelectorAll('.delete-notif').forEach(btn=>{
      btn.onclick = async (e)=>{
        const id = btn.getAttribute('data-id');
        await deleteNotification(id);
      };
    });
  }catch(e){ console.warn('renderNotificationsList', e); }
}

// Scroll controls helpers for notification modal
function updateNotificationScrollControls(){
  try{
    const container = document.getElementById('notificationContent');
    const btnTop = document.getElementById('notifScrollTop');
    const btnBottom = document.getElementById('notifScrollBottom');
    if(!container) return;
    if(btnTop) btnTop.disabled = container.scrollTop === 0;
    if(btnBottom) btnBottom.disabled = container.scrollTop + container.clientHeight >= container.scrollHeight - 1;
  }catch(e){}
}

function scrollNotificationToTop(){ try{ const c=document.getElementById('notificationContent'); if(!c) return; c.scrollTo({ top:0, behavior:'smooth' }); setTimeout(updateNotificationScrollControls,200); }catch(e){}
}
function scrollNotificationToBottom(){ try{ const c=document.getElementById('notificationContent'); if(!c) return; c.scrollTo({ top: c.scrollHeight, behavior:'smooth' }); setTimeout(updateNotificationScrollControls,200); }catch(e){}
}

// Wire scroll buttons after DOM ready
document.addEventListener('DOMContentLoaded', function(){
  try{
    const btnTop = document.getElementById('notifScrollTop');
    const btnBottom = document.getElementById('notifScrollBottom');
    const container = document.getElementById('notificationContent');
    if(btnTop) btnTop.addEventListener('click', scrollNotificationToTop);
    if(btnBottom) btnBottom.addEventListener('click', scrollNotificationToBottom);
    if(container){
      container.addEventListener('scroll', updateNotificationScrollControls);
      // ensure controls reflect initial state whenever notifications render
      const obs = new MutationObserver(()=> setTimeout(updateNotificationScrollControls,80));
      obs.observe(container, { childList:true, subtree:true });
    }
    // Initial sync
    setTimeout(updateNotificationScrollControls, 300);
  }catch(e){ console.warn('Could not wire notif scroll controls', e); }
});

function toggleNotificationRead(id){
  try{
    const set = getReadNotificationIds();
    const sid = String(id);
    if(set.has(sid)) set.delete(sid); else set.add(sid);
    setReadNotificationIds(set);
    // reflect immediately
    if(window.notifications) renderNotificationsList(window.notifications);
    else fetchNotifications();
    updateNotifBadgeFromList(window.notifications || []);
  }catch(e){ console.warn(e); }
}

async function deleteNotification(id){
  try{
    if(!id) return; const ok = await showConfirm('Delete this notification? This cannot be undone.'); if(!ok) return;
    // Try to delete from Supabase (best-effort). If no permission, fall back to removing from client list.
    try{
      const { error } = await supabase.from('notifications').delete().eq('id', id);
      if(error) throw error;
      showToast('Notification deleted', 'success', 3000);
    }catch(err){ console.warn('Could not delete on server, removing locally:', err); showToast('Could not delete server-side; removed locally', 'error', 4000); }
    // Remove locally
    if(window.notifications) window.notifications = (window.notifications || []).filter(x => String(x.id) !== String(id));
    renderNotificationsList(window.notifications || []);
    updateNotifBadgeFromList(window.notifications || []);
  }catch(e){ console.warn('deleteNotification', e); showToast('Could not delete notification', 'error', 4000); }
}


// Open notification modal when bell clicked — initialize immediately whether DOMContentLoaded fired or not
function initNotificationBell(){
  try{
    const bell = document.getElementById('notifBell');
    if (!bell) { console.warn('notifBell not found'); return; }

    // define handler and attach in a safe way (store ref on element to allow removal)
    const handler = async function (ev){
      try{
        console.log('[notif] bell clicked');
        await fetchNotifications();
        const modal = document.getElementById('notificationModal');
            if (modal) {
          try {
            // Use explicit show helper to avoid toggle races and optionally disable animation
            showNotificationModal({ disableAnimation: true });
            console.log('[notif] opened modal via showNotificationModal');
          } catch (e) {
            console.warn('[notif] failed to open modal via showNotificationModal, falling back to direct show', e);
            modal.classList.add('show');
            modal.style.display = 'flex';
            modal.style.zIndex = 99999;
          }
        } else {
          console.warn('[notif] notificationModal element not found');
        }
        const badge = document.getElementById('notifBadge'); if (badge) badge.style.display = 'none';
      } catch (e) { console.warn('notification click handler', e); }
    };

    // remove previous handler if present
    if (bell._notifHandler) bell.removeEventListener('click', bell._notifHandler);
    bell._notifHandler = handler;
    bell.addEventListener('click', handler);
    console.log('[notif] listener attached');
  } catch (e) { console.warn('initNotificationBell', e); }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', ()=>{ initNotificationBell(); fetchNotifications(); });
} else {
  initNotificationBell(); fetchNotifications();
}

// debug button removed

/* ---------- SMS proxy config (server-side proxy recommended) ---------- */
// Configure your deployed proxy/edge-function URL here. Do NOT place API keys in client-side code.
if (typeof window.USE_PROXY === 'undefined') window.USE_PROXY = true;
// Default to the Supabase Edge Function provided by the user to avoid relying on a local proxy during deployment.
if (typeof window.PROXY_ENDPOINT === 'undefined') window.PROXY_ENDPOINT = 'https://fyriapqeztevzkcaaiqw.supabase.co/functions/v1/hyper-action';

// Sends SMS via the configured proxy. Attempts a bulk send first (preferred),
// then falls back to per-number sends when necessary. Records best-effort history
// to the `sms_messages` table.
async function sendViaProxy(phoneNumbers, message, meta) {
  if (!phoneNumbers || phoneNumbers.length === 0) return;

  // Limit bulk to 500 recipients to avoid very large payloads
  const phones = (phoneNumbers || []).slice(0, 500);

  if (window.USE_PROXY && window.PROXY_ENDPOINT) {
    try {
      const bulkBody = { phones, message, meta };
      const resp = await fetch(window.PROXY_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(bulkBody)
      });

      let text = '';
      try { text = await resp.text(); } catch (e) { text = String(resp.status || 'no response'); }

      // Record an intent / summary row. If desired, server-side logging will
      // record per-phone details; this is a best-effort client-side record.
      try {
        await supabase.from('sms_messages').insert([{
          student_id: (meta && meta.student_id) || null,
          phone: phones.length === 1 ? phones[0] : null,
          recipient_count: phones.length,
          message,
          created_at: new Date().toISOString(),
          status: resp.ok ? 'sent' : 'failed',
          gateway_response: text
        }]);
      } catch (e) { /* non-blocking */ }

      if (resp.ok) return; // bulk succeeded, no per-number fallback needed
      console.warn('Bulk send returned non-OK status, falling back to per-number sends', resp.status, text);
    } catch (e) {
      console.warn('Bulk send failed, falling back to per-number sends', e);
    }
  }

  // Per-number fallback (slower but reliable for small lists)
  for (let i = 0; i < phoneNumbers.length; i++) {
    const to = phoneNumbers[i];
    try {
      const resp = await fetch(window.PROXY_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to, message, meta })
      });

      let text = '';
      try { text = await resp.text(); } catch(e) { text = String(resp.status || 'no response'); }

      try {
        await supabase.from('sms_messages').insert([{ student_id: (meta && meta.student_id) || null, phone: to, message, created_at: new Date().toISOString(), status: resp.ok ? 'sent' : 'failed', gateway_response: text }]);
      } catch (e) { /* non-blocking */ }
    } catch (e) {
      console.warn('Failed sending SMS to', to, e);
      try { await supabase.from('sms_messages').insert([{ student_id: (meta && meta.student_id) || null, phone: to, message, created_at: new Date().toISOString(), status: 'failed', gateway_response: String(e) }]); } catch(_){ }
    }
    await new Promise(res => setTimeout(res, 250));
  }
}

/* ---------- Local storage (initial) ---------- */
let studentId   = localStorage.getItem('studentId') || null;
const _localEmail = localStorage.getItem('studentEmail') || '';
const _localName  = localStorage.getItem('studentName')  || '';
const _localLevel = localStorage.getItem('studentLevel') || '';
const _localDept  = localStorage.getItem('studentDepartment') || '';

/* Expose useful globals (will be overwritten by Supabase when available) */
window.studentId = studentId;
window.studentEmail = _localEmail;
window.studentName = _localName;
window.studentDept = _localDept;
window.studentLevel = _localLevel;

// Enforce login/redirect: require the signup/login flow to have set the
// `studentInfoSaved` marker. This ensures only the portal login logic
// (in `signup.html`) can sign a student into the dashboard.
(function enforceStudentLogin(){
  try{
    const allowed = (localStorage.getItem('studentInfoSaved') === '1');
    if(!allowed){
      // Clear any partially populated keys for safety and redirect to login
      try{ localStorage.removeItem('student_data'); }catch(e){}
      try{ localStorage.removeItem('studentId'); }catch(e){}
      try{ localStorage.removeItem('studentEmail'); }catch(e){}
      try{ localStorage.removeItem('studentName'); }catch(e){}
      // Use replace so browser history doesn't keep the protected page
      window.location.replace('signup.html');
    }
  }catch(e){ console.warn('Enforce login check failed', e); }
})();

/* Also split local name into first/last as fallback */
const _parts = (_localName || '').trim().split(/\s+/);
window.studentFirstName = _parts[0] || '';
window.studentLastName  = _parts.slice(1).join(' ') || '';

/* ---------- Totals (DB-backed) ---------- */
// Canonical fee constants
const TUITION = 2550; // full tuition
const FEE_SRC = 50;
const FEE_MEDICAL = 80;
const FEE_DEPT = 50;

// Computed payable total
let totalPayable = TUITION + FEE_SRC + FEE_MEDICAL + FEE_DEPT; // 2730
let totalPaid = 0;
let outstandingBalance = totalPayable;

// Fetch payments for a student and compute summary
async function fetchPaymentsSummary(studentIdParam){
  if(!studentIdParam) return { totalPaid: 0, tuitionPaid: 0, srcPaid:0, medPaid:0, deptPaid:0, rows: [] };
  try{
    const { data: payments, error } = await supabase
      .from('payments')
      .select('amount, fee_breakdown, fee_type, status')
      .eq('student_id', studentIdParam)
      .in('status', ['paid','success']);

    if(error){
      console.error('fetchPaymentsSummary failed (initial select):', error);
      // Try a more permissive fallback to select all columns if the initial select failed (schema mismatch)
      try{
        const { data: altPayments, error: altError } = await supabase.from('payments').select('*').eq('student_id', studentIdParam).in('status', ['paid','success']);
        if(altError){
          console.error('fetchPaymentsSummary fallback also failed:', altError);
          // Helpful hint for common schema mismatch (missing column)
          if(error.code === '42703' || (error.message && error.message.includes('payment_type'))){
            console.error('It looks like your `payments` table does not have a `payment_type` column. Either remove references to `payment_type` in client code and SQL triggers, or add the column to your database.');
          }
          return { totalPaid: 0, tuitionPaid:0, srcPaid:0, medPaid:0, deptPaid:0, rows: [] };
        }
        // use altPayments as payments
        payments = altPayments || [];
      }catch(fallbackErr){
        console.error('fetchPaymentsSummary fallback exception:', fallbackErr);
        return { totalPaid: 0, tuitionPaid:0, srcPaid:0, medPaid:0, deptPaid:0, rows: [] };
      }
    }

    let tuitionPaid=0, srcPaid=0, medPaid=0, deptPaid=0;
    let total = 0;
    (payments || []).forEach(p=>{
      const amt = Number(p.amount) || 0;
      total += amt;
      const breakdownMap = parseBreakdownToMap(p.fee_breakdown);
      const breakdownSum = Object.values(breakdownMap).reduce((s,x)=>s+x,0);
      if(breakdownSum > 0){
        tuitionPaid += breakdownMap.tuition || 0;
        srcPaid += breakdownMap.src || 0;
        medPaid += breakdownMap.medical || 0;
        deptPaid += breakdownMap.departmental || 0;
      } else {
        const type = ((p.payment_type || p.fee_type || '')).toString().toLowerCase();
        if(type.includes('tuition')) tuitionPaid += amt;
        else if(type.includes('src')) srcPaid += amt;
        else if(type.includes('medical')) medPaid += amt;
        else if(type.includes('department')) deptPaid += amt;
      }
    });

    return { totalPaid: total, tuitionPaid, srcPaid, medPaid, deptPaid, rows: payments || [] };
  }catch(err){ console.error('fetchPaymentsSummary error', err); return { totalPaid: 0, tuitionPaid:0, srcPaid:0, medPaid:0, deptPaid:0, rows: [] }; }
}
// Expose for other scripts
try{ window.fetchPaymentsSummary = fetchPaymentsSummary; }catch(e){}

// Refresh totals from DB and update UI/storage
async function refreshTotalsFromDB(){
  try{
    console.log('[refreshTotalsFromDB] starting, studentId=', studentId);
    if(!studentId){ console.warn('[refreshTotalsFromDB] no studentId available'); return; }
    try{ showTotalsSpinner(true); }catch(e){}
    const sum = await fetchPaymentsSummary(studentId);
    totalPaid = Number(sum.totalPaid) || 0;
    outstandingBalance = Math.max(0, totalPayable - totalPaid);
    saveTotalsToStorage();
    updateDashboardUI();
    try{ await refreshRegisterButtonState(); }catch(e){ /* ignore */ }
    // Also refresh history table so it stays in sync
    const rows = await renderHistoryTable('', { useCacheFirst: false }, studentId);
    console.log('[refreshTotalsFromDB] fetched totals:', { totalPaid, outstandingBalance, rowsCount: (rows?rows.length:0) });
    return Object.assign({ rows: rows || [] }, sum || {});
  }catch(e){ console.error('refreshTotalsFromDB failed', e); }
  finally{ try{ showTotalsSpinner(false); }catch(e){} }
}

// Update register button enabled/disabled state based on eligibility
async function refreshRegisterButtonState(){
  try{
    const btn = document.getElementById('registerCoursesBtn');
    if(!btn) return;
    const allowed = await hasRegistrationAccess(studentId);
    btn.disabled = !allowed;
    btn.style.opacity = allowed ? '' : '0.6';
    btn.title = allowed ? 'You may proceed to register courses' : 'You must pay required fees before registering';
  }catch(e){ console.warn('refreshRegisterButtonState failed', e); }
}

// Fetch total paid amount for a given studentId (authoritative) and update UI
async function fetchTotalPaidFromDB(studentIdParam){
  try{
    const sid = studentIdParam || studentId;
    if(!sid) return 0;
    // Reuse summary helper
    const summary = await fetchPaymentsSummary(sid);
    const paid = Number(summary.totalPaid) || 0;
    totalPaid = paid;
    outstandingBalance = Math.max(0, totalPayable - totalPaid);
    saveTotalsToStorage();
    updateDashboardUI();
    return paid;
  }catch(e){ console.error('fetchTotalPaidFromDB failed', e); return 0; }
}
window.fetchTotalPaidFromDB = fetchTotalPaidFromDB;

function showTotalsSpinner(visible){
  try{
    const el = document.getElementById('totalsSpinner');
    if(!el) return;
    el.style.display = visible ? 'inline-block' : 'none';
  }catch(e){ }
}


/* Manual receipt/upload feature removed */
const RECEIPTS_BUCKET = 'student-receipts';

/* ---------- Helpers ---------- */
function toggleModal(id){
  const m = document.getElementById(id);
  if(!m) return;
  // If showing, ensure modal is placed directly under <body> so it's not clipped
  const willShow = !m.classList.contains('show');
  if (willShow) {
    try {
      if (m.parentElement !== document.body) document.body.appendChild(m);
      // Immediately set visible inline styles to avoid being clipped or overridden
      m.style.position = m.style.position || 'fixed';
      m.style.inset = m.style.inset || '0';
      m.style.display = 'flex';
      m.style.alignItems = 'center';
      m.style.justifyContent = 'center';
      m.style.visibility = 'visible';
      m.style.opacity = '1';
      m.style.pointerEvents = 'auto';
      m.style.zIndex = 200000;
      // Ensure the modal-content has reasonable sizing so getBoundingClientRect is not zero
      const content = m.querySelector('.modal-content');
      if(content){
        content.style.maxWidth = content.style.maxWidth || '720px';
        content.style.width = content.style.width || '90%';
        content.style.margin = content.style.margin || '6% auto';
        content.style.display = content.style.display || 'block';
      }
      // Mark that we intended the modal to be visible so diagnostics can
      // distinguish intentional animation from accidental invisibility.
      try{ m.dataset.intendedVisible = '1'; }catch(e){}
    } catch (e) { /* ignore DOM append errors */ }
  }

  const isShown = m.classList.toggle('show');
  // When hiding, keep a tiny delay before removing display to allow CSS transitions
  if(isShown){
    m.style.display = 'flex';
  } else {
    try{
      // allow any hide animation to run then remove from flow
      // clear intended-visible mark when hiding
      try{ delete m.dataset.intendedVisible; }catch(e){}
      setTimeout(()=>{ try{ m.style.display = 'none'; }catch(e){} }, 120);
    }catch(e){ m.style.display = 'none'; }
  }

  // Diagnostics: if modal does not appear visible in the page, log helpful info
  // and attempt to force visible inline styles so it isn't clipped by parent containers.
  try{
    // Delay diagnostics longer to allow CSS enter transitions to complete
    // (some modals animate opacity/transform over ~300ms). This avoids
    // forcing visible styles while an intentional animation is in progress.
    setTimeout(() => {
      try{
        const cs = window.getComputedStyle(m);
        // Diagnostic logs removed to avoid noisy console output in production.
        // If you need diagnostics temporarily, uncomment the lines below.
        // console.log(`[modal] toggleModal(${id}) -> parent=${m.parentElement?m.parentElement.tagName:'(none)'} display=${cs.display} visibility=${cs.visibility} opacity=${cs.opacity} zIndex=${cs.zIndex}`);
        let rect = { width: 0, height: 0 };
        try { rect = m.getBoundingClientRect(); } catch(e) { /* ignore */ }

        const looksInvisible = (cs.display !== 'flex' && cs.display !== 'block') || (rect.width === 0 && rect.height === 0) || cs.visibility === 'hidden' || parseFloat(cs.opacity || '1') === 0;
        // If we intentionally just showed the modal, defer forcing styles until
        // after the transition window to avoid noisy warnings. We mark intended
        // visibility when showing above.
        if (looksInvisible) {
          // Only force styles if this modal was intended to be visible but is still
          // computed invisible after the animation window.
          const intended = !!m.dataset.intendedVisible;
          if (!intended) return;
          console.warn(`[modal] ${id} still appears invisible after animation — forcing visible inline styles and high z-index to avoid clipping`);
          try{
            m.style.position = 'fixed';
            m.style.top = '0';
            m.style.left = '0';
            m.style.width = '100%';
            m.style.height = '100%';
            m.style.display = 'flex';
            m.style.visibility = 'visible';
            m.style.opacity = '1';
            m.style.pointerEvents = 'auto';
            m.style.zIndex = '200000';
            m.classList.add('show');
          }catch(e){ console.warn('[modal] forcing styles failed', e); }
        }
      }catch(e){ console.warn('[modal] diagnostics inner failed', e); }
    }, 360);
  }catch(e){ console.warn('[modal] diagnostics setup failed', e); }
  // If the Student Info modal is opened, ensure it's read-only when profile exists on server/local
  if(isShown && id === 'studentInfoModal'){
    (async ()=>{
      try{
        // If we have a local saved flag, prefer that (fast)
        const localComplete = (localStorage.getItem('studentInfoSaved') === '1') || (!!localStorage.getItem('studentId') && !!localStorage.getItem('studentName'));
        if(localComplete){ setStudentFormReadOnly(true); return; }
        // Otherwise, check server-side (may be slow)
        const complete = await checkStudentProfileComplete();
        if(complete) setStudentFormReadOnly(true);
        else setStudentFormReadOnly(false);
      }catch(e){ console.warn('Could not determine profile completeness:', e); }
    })();
  }
}
window.toggleModal = toggleModal;

// Explicit show/hide helpers for the notification modal to avoid toggle race conditions
function showNotificationModal(options = {}){
  try{
    const m = document.getElementById('notificationModal'); if(!m) return;
    const disableAnimation = !!(options && options.disableAnimation);
    if(disableAnimation) m.classList.add('no-animation'); else m.classList.remove('no-animation');
    if (m.parentElement !== document.body) document.body.appendChild(m);
    m.style.zIndex = 150000;
    m.classList.add('show');
    m.style.display = 'flex';
    m.style.visibility = 'visible';
    m.style.opacity = '1';
    // ensure focus for accessibility
    const focusable = m.querySelector('button, [tabindex]'); if(focusable) try{ focusable.focus(); }catch(e){}
  }catch(e){ console.warn('showNotificationModal failed', e); }
}
function hideNotificationModal(){
  try{
    const m = document.getElementById('notificationModal'); if(!m) return;
    m.classList.remove('show');
    m.style.display = 'none';
    m.style.visibility = 'hidden';
    m.style.opacity = '0';
    m.classList.remove('no-animation');
  }catch(e){ console.warn('hideNotificationModal failed', e); }
}
window.showNotificationModal = showNotificationModal;
window.hideNotificationModal = hideNotificationModal;

function closeIfBackdrop(event){
  if(event.target.classList && event.target.classList.contains('modal')){
    event.target.classList.remove('show');
    event.target.style.display = 'none';
  }
}
window.closeIfBackdrop = closeIfBackdrop;

// Global modal helper to replace alert()
function showModalMessage(message, title = 'Notice'){
  try{
    let titleEl = document.getElementById('globalMessageTitle');
    let bodyEl = document.getElementById('globalMessageBody');
    if(!titleEl || !bodyEl){
      // If modal DOM not yet present, create minimal modal markup and attach
      const modalHtml = `
        <div id="globalMessageModal" class="modal">
          <div class="modal-content">
            <div class="modal-header"><h2 id="globalMessageTitle">${escapeHtml(title)}</h2><button class="close-btn" onclick="toggleModal('globalMessageModal')">&times;</button></div>
            <div class="modal-body"><div id="globalMessageBody" style="white-space:pre-wrap;">${escapeHtml(String(message))}</div></div>
            <div class="modal-footer"><button class="btn" onclick="toggleModal('globalMessageModal')">OK</button></div>
          </div>
        </div>`;
      const div = document.createElement('div'); div.innerHTML = modalHtml; document.body.appendChild(div.firstElementChild);
      titleEl = document.getElementById('globalMessageTitle'); bodyEl = document.getElementById('globalMessageBody');
    }
    if(titleEl) titleEl.textContent = title;
    if(bodyEl) bodyEl.textContent = typeof message === 'string' ? message : JSON.stringify(message);
    toggleModal('globalMessageModal');
  }catch(e){ try{ console.warn('Modal unavailable — message:', message); }catch(_){ /* nothing */ } }
}
// Ensure other scripts can call the modal helper
try{ window.showModalMessage = showModalMessage; }catch(e){}

// Ensure consistent modal styles (added once)
(function ensureGlobalModalStyles(){
  if (document.getElementById('globalModalStyles')) return;
  const s = document.createElement('style');
  s.id = 'globalModalStyles';
  s.textContent = `
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999}
    .modal-content{background:#fff;border-radius:8px;max-width:720px;width:90%;box-shadow:0 8px 24px rgba(0,0,0,0.2);overflow:hidden}
    .modal-header{padding:12px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
    .modal-body{padding:16px}
    .modal-footer{padding:12px 16px;border-top:1px solid #eee;text-align:right}
    .close-btn{background:transparent;border:0;font-size:20px;cursor:pointer}
    .btn{background:#0066cc;color:#fff;border:0;padding:8px 12px;border-radius:4px;cursor:pointer}
    .btn.secondary{background:#e0e0e0;color:#111}
  `;
  document.head.appendChild(s);
})();

// Async confirm modal that returns a boolean
function showConfirm(message, title = 'Please confirm'){
  return new Promise((resolve)=>{
    try{
      let modal = document.getElementById('globalConfirmModal');
      if (!modal){
        const div = document.createElement('div');
        div.innerHTML = `
          <div id="globalConfirmModal" class="modal" style="display:none;">
            <div class="modal-content">
              <div class="modal-header"><h3 id="globalConfirmTitle"></h3><button class="close-btn" id="globalConfirmClose">&times;</button></div>
              <div class="modal-body"><div id="globalConfirmBody" style="white-space:pre-wrap;"></div></div>
              <div class="modal-footer"><button class="btn secondary" id="globalConfirmNo">No</button> <button class="btn" id="globalConfirmYes">Yes</button></div>
            </div>
          </div>`;
        document.body.appendChild(div.firstElementChild);
        modal = document.getElementById('globalConfirmModal');
        document.getElementById('globalConfirmClose').addEventListener('click', ()=>{ modal.style.display='none'; resolve(false); });
      }
      document.getElementById('globalConfirmTitle').textContent = title;
      document.getElementById('globalConfirmBody').textContent = typeof message === 'string' ? message : JSON.stringify(message);
      modal.style.display = 'flex';

      const yesBtn = document.getElementById('globalConfirmYes');
      const noBtn = document.getElementById('globalConfirmNo');

      function cleanup(){
        modal.style.display='none';
        yesBtn.removeEventListener('click', onYes);
        noBtn.removeEventListener('click', onNo);
      }

      function onYes(){ cleanup(); resolve(true); }
      function onNo(){ cleanup(); resolve(false); }

      yesBtn.addEventListener('click', onYes);
      noBtn.addEventListener('click', onNo);
    }catch(e){ console.warn('showConfirm failed:', e); resolve(false); }
  });
}

function isValidEmail(email){ return /[^@\s]+@[^@\s]+\.[^@\s]+/.test(email||''); }
function getValidEmail(){
  if(isValidEmail(window.studentEmail)) return window.studentEmail;
  if(isValidEmail(_localEmail)) return _localEmail;
  const t = (document.getElementById('student-email')?.textContent || '').trim();
  return isValidEmail(t) ? t : null;
}
function gh(amount){ return Number(amount || 0).toFixed(2); }

// Friendly currency formatter (used by SMS messages and some UI bits)
function cedis(n){ return `GHS ${Number(n || 0).toFixed(2)}`; }

function saveTotalsToStorage(){
  localStorage.setItem('dashboardTotals', JSON.stringify({ totalPayable, totalPaid, outstandingBalance }));
}

// Called by the signup/login flow when a student logs in with their student ID and email.
// This stores their ID+email in localStorage and updates runtime vars. Call this from
// your signup/login page after a successful authentication: `window.setLoggedInStudent(id,email)`.
window.setLoggedInStudent = function(id, email){
  try{
    if(id) { localStorage.setItem('studentId', String(id)); window.studentId = String(id); studentId = String(id); }
    if(email) { localStorage.setItem('studentEmail', String(email)); window.studentEmail = String(email); }
  }catch(e){ console.warn('Could not persist login info', e); }
  // If the dashboard is already initialized, refresh its state
  try{ if(typeof initDashboard === 'function') initDashboard(); }catch(e){}
  // Lookup the student across both tables and populate UI
  (async function(){
    try{
      if(id && String(id).trim() !== ''){
        await lookupStudentInBothTables(String(id).trim());
      }
    }catch(err){ console.warn('Lookup after login failed', err); }
  })();
};

function updateDashboardUI(){
  const payableEl = document.getElementById('totalPayable');
  const paidEl    = document.getElementById('totalPaid');
  const outEl     = document.getElementById('outstandingBalance');
  if(payableEl) payableEl.innerText = `GHS ${totalPayable.toFixed(2)}`;
  if(paidEl)    paidEl.innerText    = `GHS ${totalPaid.toFixed(2)}`;
  if(outEl)     outEl.innerText     = `GHS ${outstandingBalance.toFixed(2)}`;
}

function updateDashboardTotals(amountPaid){
  const amt = Number(amountPaid) || 0;
  totalPaid += amt;
  outstandingBalance = totalPayable - totalPaid;
  saveTotalsToStorage();
  updateDashboardUI();
}

/* ---------- Safe HTML escape ---------- */
function escapeHtml(s){
  if(!s && s !== 0) return '';
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ---------- Toast helpers for user-friendly messages ---------- */
function showToast(message, type = 'success', duration = 5000) {
  try {
    const container = document.getElementById('toastContainer');
    if(!container) return console.warn('Toast container missing');

    const toast = document.createElement('div');
    toast.className = 'toast ' + (type === 'error' ? 'toast--error' : 'toast--success');
    toast.innerHTML = `<div style="flex:1">${escapeHtml(String(message))}</div>`;

    const closeBtn = document.createElement('button');
    closeBtn.className = 'toast-close';
    closeBtn.innerHTML = '&times;';
    closeBtn.onclick = () => { toast.remove(); };
    toast.appendChild(closeBtn);

    container.appendChild(toast);

    if(duration > 0) {
      setTimeout(()=>{
        try { toast.remove(); } catch(e){}
      }, duration);
    }
  } catch(e) { console.error('showToast error', e); }
}

// Small top-right ephemeral modal used to confirm received data
function showCornerModal(message, duration = 6000) {
  try {
    const existing = document.querySelector('.corner-modal');
    if (existing) existing.remove();

    const el = document.createElement('div');
    el.className = 'corner-modal';
    el.innerHTML = `<div class="corner-icon"><i class="fas fa-check-circle"></i></div><div class="corner-text">${escapeHtml(String(message))}</div><button class="corner-close" aria-label="close">&times;</button>`;

    const closeBtn = el.querySelector('.corner-close');
    closeBtn.addEventListener('click', () => { try{ el.remove(); }catch(e){} });

    document.body.appendChild(el);

    if (duration > 0) setTimeout(() => { try{ el.remove(); }catch(e){} }, duration);
  } catch (err) { console.error('showCornerModal error', err); }
}

function formatSupabaseError(err){
  if(!err) return null;
  // Supabase error objects often include message, details or hint
  if(typeof err === 'string') return err;
  if(err.message) return err.message;
  if(err.msg) return err.msg;
  try {
    // Some errors are nested
    const json = JSON.stringify(err);
    return json;
  } catch(e){}
  return 'Unknown server error';
}

/* ---------- Create receipt modal if missing (ensures showReceipt always works) ---------- */
function ensureReceiptModalExists(){
  if(document.getElementById('receiptModal')) return;
  const modal = document.createElement('div');
  modal.id = 'receiptModal';
  modal.className = 'modal';
  modal.style.display = 'none';
  modal.style.position = 'fixed';
  modal.style.left = '0';
  modal.style.top = '0';
  modal.style.width = '100%';
  modal.style.height = '100%';
  modal.style.background = 'rgba(0,0,0,0.5)';
  modal.style.zIndex = '9999';
  modal.onclick = closeIfBackdrop;

  const contentWrap = document.createElement('div');
  contentWrap.className = 'modal-content';
  contentWrap.style.maxWidth = '700px';
  contentWrap.style.margin = '6% auto';
  contentWrap.style.background = '#fff';
  contentWrap.style.borderRadius = '10px';
  contentWrap.style.position = 'relative';
  contentWrap.onclick = (e) => e.stopPropagation();

  const closeBtn = document.createElement('button');
  closeBtn.className = 'close-btn';
  closeBtn.innerHTML = '&times;';
  closeBtn.style.position = 'absolute';
  closeBtn.style.right = '10px';
  closeBtn.style.top = '8px';
  closeBtn.style.border = 'none';
  closeBtn.style.background = 'transparent';
  closeBtn.style.fontSize = '22px';
  closeBtn.style.cursor = 'pointer';
  closeBtn.onclick = () => toggleModal('receiptModal');

  const content = document.createElement('div');
  content.id = 'receiptContent';
  content.style.padding = '18px';

  contentWrap.appendChild(closeBtn);
  contentWrap.appendChild(content);
  modal.appendChild(contentWrap);
  document.body.appendChild(modal);
}

/* ---------- Fetch student profile from Supabase (robust) ---------- */
async function fetchStudentProfile(){
  if(!studentId) return;
  try {
    const { data, error } = await supabase
      .from('students')
      .select('firstname, lastname, email, department, level, phone, school, course_type, notification_unread, last_notification_at')
      .eq('student_id', studentId.trim())
      .maybeSingle();

    if(error || !data){
      if(error) console.warn('Supabase profile fetch failed, using localStorage:', error.message);
      return;
    }

    window.studentFirstName = data.firstname || '';
    window.studentLastName  = data.lastname  || '';
    window.studentName      = `${data.firstname || ''}${data.othername ? ' ' + data.othername : ''} ${data.lastname || ''}`.trim();
    window.studentEmail     = data.email || '';
    window.studentDept      = data.department || '';
    window.studentLevel     = data.level || '';
    window.studentPhone     = data.phone || '';
    window.studentSchool    = data.school || '';
    window.studentCourseType = data.course_type || '';
    window.studentOtherName = data.othername || '';
    // Notification fields (may be absent on some schemas)
    try {
      window.studentLastNotification = data.last_notification || '';
      window.studentNotificationUnread = !!data.notification_unread;
      window.studentLastNotificationAt = data.last_notification_at || null;
    } catch(e) {
      window.studentLastNotification = '';
      window.studentNotificationUnread = false;
      window.studentLastNotificationAt = null;
    }

    try {
      localStorage.setItem('studentName', window.studentName);
      localStorage.setItem('studentEmail', window.studentEmail);
      localStorage.setItem('studentDepartment', window.studentDept);
      localStorage.setItem('studentLevel', window.studentLevel);
      localStorage.setItem('studentPhone', window.studentPhone);
      localStorage.setItem('studentSchool', window.studentSchool);
      localStorage.setItem('studentCourseType', window.studentCourseType);
      localStorage.setItem('studentOtherName', window.studentOtherName || '');
    } catch(e) { /* ignore */ }

    // Render notification banner if present
    try { renderStudentNotification(); } catch(e) {}

    return data;

  } catch(err){
    console.error('Profile fetch crashed, using localStorage fallback:', err);
  }
  // Expose for other scripts that may run outside the module scope
  try{ window.fetchStudentProfile = fetchStudentProfile; }catch(e){}
}

/* Password reset functionality removed per request */

/* ---------- Check if student has completed profile ---------- */
async function checkStudentProfileComplete() {
  // Prefer check by studentId when available
  try {
    if (studentId && String(studentId).trim() !== '') {
      const { data, error } = await supabase
        .from('students')
        .select('student_id, firstname, lastname, department, level, phone, school, course_type')
        .eq('student_id', studentId.trim())
        .maybeSingle();

      if (data && !error) {
        // If a row exists for this studentId, treat as complete only when required fields are present
        return !!(data.firstname && data.lastname && data.department && data.level && data.phone && data.school && data.course_type);
      }
    }

    // Fallback: if there's a logged-in email, check by email. This makes it so
    // a student who signs up (email saved at login) and later opens the dashboard
    // with that same email won't be forced to refill the form if their row exists.
    const email = (window.studentEmail || localStorage.getItem('studentEmail') || '').toString().trim();
    if (email) {
      const { data: byEmail, error: emailErr } = await supabase
        .from('students')
        .select('student_id, firstname, lastname, department, level, phone, school, course_type')
        .ilike('email', email)
        .maybeSingle();

      if (byEmail && !emailErr) {
        // If we found a row by email, ensure runtime studentId matches for later operations
        try{ if(!studentId) { studentId = byEmail.student_id || studentId; window.studentId = studentId; localStorage.setItem('studentId', studentId || ''); } }catch(e){}
        return !!(byEmail.firstname && byEmail.lastname && byEmail.department && byEmail.level && byEmail.phone && byEmail.school && byEmail.course_type);
      }
    }

    return false;
  } catch (err) {
    console.error('Error checking student profile:', err);
    return false;
  }
}

// Helper: check if a student row exists (any row) — returns the row or null
async function fetchStudentRow(studentIdParam){
  if(!studentIdParam) return null;
  try{
    const { data, error } = await supabase
      .from('students')
      .select('*')
      .eq('student_id', studentIdParam.trim())
      .maybeSingle();
    if(error) return null;
    return data || null;
  }catch(err){ return null; }
}

/* ---------- Save student profile to Supabase ---------- */
async function saveStudentProfile(profileData) {
  try {
    // Ensure we have a studentId to upsert against. If none, generate a fallback id
    // and persist it locally so subsequent calls use the same id.
    if (!studentId || String(studentId).trim() === '') {
      // Prefer the provided profileData.student_id if present
      const provided = (profileData.student_id || '').toString().trim();
      if (provided) {
        studentId = provided;
      } else {
        studentId = `GTU-${Date.now()}-${Math.floor(Math.random()*9000+1000)}`;
      }
      window.studentId = studentId;
      try { localStorage.setItem('studentId', studentId); } catch(e){}
    }

    const payload = {
      student_id: studentId,
      firstname: profileData.firstname || '',
      lastname: profileData.lastname || '',
      department: profileData.department || '',
      level: profileData.level || '',
      phone: profileData.phone || '',
      school: profileData.school || '',
      email: profileData.email || '',
      course_type: profileData.course_type || '',
      program: profileData.program || profileData.department || null,
      program_duration: profileData.program_duration || null,
      admission_number: profileData.admission_number || profileData.student_id || studentId || null,
      othername: profileData.othername || null
    };

    // Use upsert so the row is created if missing, or updated if present.
    const { data, error } = await supabase
      .from('students')
      .upsert([payload], { onConflict: 'student_id' })
      .select();

    if (error) {
      console.error('Supabase upsert error for students:', error);
      throw error;
    }

    // Persist studentId and name locally in case DB replication or policies prevent immediate visibility
    try {
      localStorage.setItem('studentId', studentId);
      localStorage.setItem('studentName', `${payload.firstname || ''} ${payload.lastname || ''}`.trim());
      localStorage.setItem('studentOtherName', payload.othername || '');
    } catch (e) {}

    console.log('Student profile upserted:', data);
    return data;
  } catch (err) {
    console.error('Error in saveStudentProfile:', err);
    throw err;
  }
}

/* ---------- Create receipt object ---------- */
function createReceipt(feeType, amount, reference, feeBreakdown='', receiptUrl='') {
  const fullName = `${window.studentFirstName || ''}${window.studentOtherName ? ' ' + window.studentOtherName : ''} ${window.studentLastName || ''}`.trim() 
    || window.studentName 
    || _localName 
    || '';
  return {
    student_id: studentId,
    student_name: fullName,
    student_email: window.studentEmail || getValidEmail(),
    department: window.studentDept,
    level: window.studentLevel,
    amount: Number(amount) || 0,
    fee_type: feeType,
    fee_breakdown: feeBreakdown,
    reference: reference || `GTU-${Date.now()}-${Math.floor(Math.random()*1e4)}`,
    receipt_number: `RCPT-${new Date().getFullYear()}-${Date.now().toString().slice(-6)}-${Math.floor(Math.random()*900 + 100)}`,
    date_iso: new Date().toISOString(),
    date_display: new Date().toLocaleString(),
    receipt_url: receiptUrl
  };
}

/* Small helper for a local receipt number */
function genRcptNo(){
  const year = new Date().getFullYear();
  const random = Math.floor(100000 + Math.random() * 900000);
  return `RCPT-${year}-${random}`;
}

/* ---------- Fixed: Save receipt to Supabase with Better Error Handling ---------- */
async function saveReceiptToSupabase(receipt) {
  try {
    console.log('Attempting to save to Supabase:', receipt);
    
    const studentName = `${window.studentFirstName || ''}${window.studentOtherName ? ' ' + window.studentOtherName : ''} ${window.studentLastName || ''}`.trim() || receipt.student_name || window.studentName || '';

    const { data, error } = await supabase
      .from('payments')
      .insert([{
        student_id: receipt.student_id || window.studentId || '',
        student_name: studentName,
        student_email: receipt.student_email || window.studentEmail || '',
        department: receipt.department || window.studentDept || '',
        level: receipt.level || window.studentLevel || '',
        amount: receipt.amount,
        fee_type: receipt.fee_type,
        fee_breakdown: receipt.fee_breakdown,
        /* Determine payment coverage for tuition payments and record percentage */
        payment_coverage: (function(){
          try{
            const tt = (receipt.fee_type || '').toString().toLowerCase();
            if (tt.includes('tuition')){
              const pct = Math.round((Number(receipt.amount || 0) / (typeof TUITION !== 'undefined' ? TUITION : 2550)) * 100);
              if (pct >= 100) return 'full';
              if (pct >= 80) return 'partial_80';
              if (pct >= 50) return 'partial_50';
              return 'partial';
            }
            // For non-tuition payments mark as full coverage of that fee
            return 'full';
          }catch(e){ return null; }
        })(),
        coverage_percent: (function(){ try{ const tt=(receipt.fee_type||'').toString().toLowerCase(); if(tt.includes('tuition')) return Math.round((Number(receipt.amount||0)/(typeof TUITION!=='undefined'?TUITION:2550))*100); return 100;}catch(e){return null;} })(),
        transaction_ref: receipt.reference,
        receipt_number: receipt.receipt_number || genRcptNo(),
        payment_date: receipt.date_iso || new Date().toISOString(),
        status: 'paid',
        source_table: 'dashboard',
        source_payload: JSON.stringify(receipt || {}),
        created_at: new Date().toISOString()
      }])
      .select();

    if (error) {
      console.error('Supabase insert error:', error);
      
      // If table doesn't exist or has schema issues, create a backup in localStorage
      try {
        const backupKey = `payment_backup_${receipt.reference}`;
        localStorage.setItem(backupKey, JSON.stringify({
          ...receipt,
          backup_timestamp: new Date().toISOString()
        }));
        console.log('Payment backed up to localStorage');
      } catch (backupError) {
        console.error('Could not create backup:', backupError);
      }
      
      throw error;
    }
    
    console.log('Successfully saved to Supabase:', data);
    return data;
  } catch (err) {
    console.error("Save receipt failed:", err);
    return null;
  }
}

/* ---------- Show receipt modal ---------- */
async function showReceipt(receipt){
  ensureReceiptModalExists();
  const modal = document.getElementById('receiptModal');
  const body  = document.getElementById('receiptContent');
  if(!modal || !body) return;

  const displayName = receipt.student_name || `${window.studentFirstName || ''}${window.studentOtherName ? ' ' + window.studentOtherName : ''} ${window.studentLastName || ''}`.trim() || window.studentName || '';

  const breakdownHtml = receipt.fee_breakdown
    ? `<div style="margin-top:6px;color:#555;"><strong>Breakdown:</strong><div style="margin-top:4px;">${escapeHtml(receipt.fee_breakdown)}</div></div>`
    : '';

  // Compute authoritative totals from DB. If this receipt is already present in DB,
  // dbTotalPaid will include it; otherwise treat dbTotalPaid as before-payment.
  let dbSummary = { totalPaid: 0, rows: [] };
  try{
    dbSummary = await fetchPaymentsSummary(receipt.student_id || studentId);
  }catch(e){ console.warn('Could not fetch payment summary for receipt display', e); }

  const dbTotalPaid = Number(dbSummary.totalPaid) || 0;
  const paymentAmt = Number(receipt.amount) || 0;

  // Try to detect whether the receipt exists in DB results (match by transaction_ref / reference / receipt_number)
  const receiptRef = (receipt.reference || receipt.transaction_ref || receipt.receipt_number || '').toString();
  const savedFound = (dbSummary.rows || []).some(r => {
    const a = String(r.transaction_ref || r.reference || r.receipt_number || '').toString();
    return a && a === receiptRef;
  });

  let outstandingBefore = 0;
  let outstandingAfter = 0;
  if(savedFound){
    // DB includes the payment; outstanding after = totalPayable - dbTotalPaid
    outstandingAfter = Math.max(0, totalPayable - dbTotalPaid);
    outstandingBefore = Math.max(0, outstandingAfter + paymentAmt);
  } else {
    // DB does not include this payment yet; assume dbTotalPaid is before payment
    outstandingBefore = Math.max(0, totalPayable - dbTotalPaid);
    outstandingAfter = Math.max(0, outstandingBefore - paymentAmt);
  }

  body.innerHTML = `
    <div style="display:flex;justify-content:center;align-items:center;">
      <div style="max-width:500px;width:100%;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.1);">
        <div style="text-align:center;margin-bottom:12px;">
          <h2 style="margin:0;color:#4a00e0;">Payment Receipt</h2>
          <div style="color:#666;font-size:13px;">${escapeHtml(receipt.date_display)}</div>
        </div>
        <div style="padding:10px 0;">
          <div><strong>Name:</strong> ${escapeHtml(displayName)}</div>
          <div><strong>Student ID:</strong> ${escapeHtml(receipt.student_id || '')}</div>
          <div><strong>Email:</strong> ${escapeHtml(receipt.student_email || '')}</div>
          <div><strong>Department:</strong> ${escapeHtml(receipt.department || '')}</div>
          <div><strong>Level:</strong> ${escapeHtml(receipt.level || '')}</div>
          <div style="margin-top:8px;"><strong>Fee Type:</strong> ${escapeHtml(receipt.fee_type || '')}</div>
          ${breakdownHtml}
          <div style="margin-top:12px;"><strong>Amount Paid:</strong> GHS ${gh(receipt.amount)}</div>
          <div style="margin-top:4px;"><strong>Receipt No:</strong> ${escapeHtml(receipt.receipt_number || receipt.reference)}</div>
          <div style="margin-top:4px;"><strong>Transaction Ref:</strong> ${escapeHtml(receipt.reference)}</div>
          <div style="margin-top:8px;color:#333;"><strong>Outstanding (before payment):</strong> GHS ${gh(outstandingBefore)}</div>
          <div style="margin-top:4px;color:#ff0000;"><strong>Outstanding (after payment):</strong> GHS ${gh(outstandingAfter)}</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:14px;justify-content:center;">
          <button id="printReceiptBtn" style="padding:8px 12px;border-radius:8px;border:none;background:#4a00e0;color:white;cursor:pointer;">Print</button>
          <button id="downloadReceiptBtn" style="padding:8px 12px;border-radius:8px;border:none;background:#ff6a00;color:white;cursor:pointer;">Download PDF</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('printReceiptBtn')?.addEventListener('click', ()=>printReceipt(receipt));
  document.getElementById('downloadReceiptBtn')?.addEventListener('click', ()=>downloadReceiptPDF(receipt));

  toggleModal('receiptModal');
}

/* ---------- Print receipt ---------- */
function printReceipt(receipt){
  const w = window.open('','_blank','width=800,height=600');
  if(!w) { showModalMessage('Could not open print window. Try downloading PDF instead.'); return; }
  const displayName = receipt.student_name || `${window.studentFirstName || ''}${window.studentOtherName ? ' ' + window.studentOtherName : ''} ${window.studentLastName || ''}`.trim() || window.studentName || '';
  const html = `<html><head><title>Receipt - ${escapeHtml(receipt.reference)}</title>
    <style>body{font-family:Inter, Arial, sans-serif;padding:20px;color:#222} h2{color:#4a00e0}</style></head>
    <body>
    <h2>Payment Receipt</h2>
    <div><strong>Date:</strong> ${escapeHtml(receipt.date_display)}</div>
    <div><strong>Name:</strong> ${escapeHtml(displayName)}</div>
    <div><strong>Student ID:</strong> ${escapeHtml(receipt.student_id||'')}</div>
    <div><strong>Fee Type:</strong> ${escapeHtml(receipt.fee_type||'')}</div>
    <div><strong>Amount:</strong> GHS ${gh(receipt.amount)}</div>
    <div><strong>Receipt No:</strong> ${escapeHtml(receipt.receipt_number || receipt.reference)}</div>
    <div><strong>Transaction Ref:</strong> ${escapeHtml(receipt.reference)}</div>
    <hr>GH TECHNICAL UNIVERSITY COLLEGE
    </body></html>`;
  w.document.write(html); w.document.close(); w.focus(); w.print();
}

/* ---------- Download receipt as PDF (jsPDF required) ---------- */
function downloadReceiptPDF(receipt) {
  try {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) {
      showModalMessage('PDF library not available. Please include jsPDF.');
      return;
    }

    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 40;
    let y = 60;
    const rowH = 22;

    const primaryBlue = '#1a237e';
    const secondaryPurple = '#4a00e0';
    const tableBorderColor = '#333';
    const rowBgColor = '#f5f5f5';

    const fullName = `${window.studentFirstName || ''}${window.studentOtherName ? ' ' + window.studentOtherName : ''} ${window.studentLastName || ''}`.trim()
      || window.studentName || 'N/A';

    if (window.schoolLogoURL) {
      const logoSize = 50;
      doc.addImage(window.schoolLogoURL, 'PNG', margin, y - 10, logoSize, logoSize);
    }

    doc.setFontSize(20).setFont('helvetica', 'bold').setTextColor(primaryBlue);
    doc.text('GH TECHNICAL UNIVERSITY COLLEGE', pageWidth / 2, y, { align: 'center' });
    y += 25;

    doc.setFontSize(12).setFont('helvetica', 'normal').setTextColor('#555');
    doc.text('P.O. Box 1234, Accra Achimota | Phone: +233 123 456 789 | Email: info@ghtu.edu.gh', pageWidth / 2, y, { align: 'center' });
    y += 30;

    doc.setFontSize(18).setFont('helvetica', 'bold').setTextColor(secondaryPurple);
    doc.text('Payment Receipt', pageWidth / 2, y, { align: 'center' });
    y += 25;

    doc.setFontSize(12).setTextColor('#333');
    doc.text(`Date: ${receipt.date_display || new Date().toLocaleDateString()}`, pageWidth - margin, y, { align: 'right' });
    y += 20;

    const tableX = margin;
    const tableWidth = pageWidth - margin * 2;
    const col1Width = tableWidth * 0.35;

    doc.setFontSize(14).setFont('helvetica', 'bold').setTextColor(primaryBlue);
    doc.text('Student Information', tableX, y);
    y += 10;

    const infoRows = [
      ['Name', fullName],
      ['Student ID', receipt.student_id || 'N/A'],
      ['Email', receipt.student_email || 'N/A'],
      ['Department', receipt.department || 'N/A'],
      ['Level', receipt.level || 'N/A'],
      ['Fee Type', receipt.fee_type || 'N/A']
    ];

    infoRows.forEach((row, idx) => {
      if (idx % 2 === 0) {
        doc.setFillColor(rowBgColor);
        doc.rect(tableX, y - 4, tableWidth, rowH, 'F');
      }
      doc.setDrawColor(tableBorderColor);
      doc.rect(tableX, y - 4, tableWidth, rowH);
      doc.setFont('helvetica', 'bold').setTextColor('#000');
      doc.text(row[0], tableX + 6, y + 14);
      doc.setFont('helvetica', 'normal');
      doc.text(String(row[1] || ''), tableX + col1Width + 6, y + 14);
      y += rowH;
    });

    if (receipt.fee_breakdown) {
      y += 15;
      doc.setFontSize(14).setFont('helvetica', 'bold').setTextColor(primaryBlue);
      doc.text('Fee Breakdown', tableX, y);
      y += 8;

      doc.setFont('helvetica', 'normal').setFontSize(12);
      const breakdownItems = String(receipt.fee_breakdown).split(',');

      breakdownItems.forEach((item, idx) => {
        const cleanItem = item.trim();
        if (!cleanItem) return;
        if (y > doc.internal.pageSize.getHeight() - 80) {
          doc.addPage();
          y = 60;
        }
        if (idx % 2 === 0) {
          doc.setFillColor(rowBgColor);
          doc.rect(tableX, y - 4, tableWidth, rowH, 'F');
        }
        doc.setDrawColor(tableBorderColor);
        doc.rect(tableX, y - 4, tableWidth, rowH);
        doc.text(`${idx + 1}. ${cleanItem}`, tableX + 6, y + 14);
        y += rowH;
      });
    }

    y += 15;
    doc.setFontSize(14).setFont('helvetica', 'bold').setTextColor(primaryBlue);
    doc.text('Payment Details', tableX, y);
    y += 8;

    const outstanding = (totalPayable - totalPaid).toFixed(2);
    const paymentRows = [
      ['Receipt No', receipt.receipt_number || 'N/A'],
      ['Amount Paid', `GHS ${gh(receipt.amount)}`],
      ['Transaction Ref', receipt.reference || 'N/A'],
      ['Outstanding Balance', `GHS ${outstanding}`]
    ];

    paymentRows.forEach((row, idx) => {
      if (idx % 2 === 0) {
        doc.setFillColor(rowBgColor);
        doc.rect(tableX, y - 4, tableWidth, rowH, 'F');
      }
      doc.setDrawColor(tableBorderColor);
      doc.rect(tableX, y - 4, tableWidth, rowH);
      doc.setFont('helvetica', 'bold').text(row[0], tableX + 6, y + 14);
      doc.setFont('helvetica', 'normal').text(String(row[1] || ''), tableX + col1Width + 6, y + 14);
      y += rowH;
    });

    y += 30;
    doc.setFontSize(10).setTextColor('#666');
    doc.text('This is a system-generated receipt from GH Technical University College.', pageWidth / 2, y, { align: 'center' });

    const safeFileName = `Receipt_${(receipt.receipt_number || receipt.reference || 'PAYMENT')}`.replace(/\s+/g, '_');
    doc.save(`${safeFileName}.pdf`);

  } catch (err) {
    console.error(err);
    showModalMessage('Error creating PDF.');
  }
}

window.downloadReceiptPDF = downloadReceiptPDF;
window.showReceipt = showReceipt;
window.printReceipt = printReceipt;

// Notification modal wiring for dashboard.html
(function(){
  function updateBadge(){
    try{
      const b = document.getElementById('notifBadge');
      if(!b) return;
      if(window.studentNotificationUnread) b.style.display = 'flex'; else b.style.display = 'none';
    }catch(e){}
  }

    document.addEventListener('DOMContentLoaded', function(){
    const bell = document.getElementById('notifBell');
    const ackBtn = document.getElementById('ackNotificationModalBtn');
    if(bell){
      // If initNotificationBell already attached a handler, avoid toggling twice.
      if(!bell._notifHandler){
        bell.addEventListener('click', async ()=>{
          try{ await fetchStudentProfile(); } catch(e){}
          try{ await fetchNotifications(); } catch(e){ console.warn('Could not fetch notifications on bell click', e); }
          // show full list
          showNotificationModal({ disableAnimation: true });
          updateBadge();
        });
      } else {
        // Primary handler exists; only refresh content and badge on clicks to avoid double-toggle
        bell.addEventListener('click', async ()=>{
          try{ await fetchStudentProfile(); } catch(e){}
          try{ await fetchNotifications(); } catch(e){ console.warn('Could not fetch notifications on bell click', e); }
          showNotificationModal({ disableAnimation: true });
          updateBadge();
        });
      }
    }

    if(ackBtn){
      ackBtn.addEventListener('click', async ()=>{
        try{ await clearStudentNotification(); } catch(e){}
        hideNotificationModal();
        updateBadge();
      });
    }

    // initial badge state
    updateBadge();
  });
})();

/* ---------- Fixed: Save Payment & Receipt with Better Error Handling ---------- */
async function savePaymentWithReceipt(feeType, amount, reference, feeBreakdown=''){
  try {
    const receipt = createReceipt(feeType, amount, reference, feeBreakdown);

    // Save to Supabase first so we have authoritative data
    const saved = await saveReceiptToSupabase(receipt);

    if (saved) {
      // Refresh totals from DB so UI reflects authoritative totals after save
      await refreshTotalsFromDB();
      await showReceipt(receipt);
      console.log('Payment successfully saved to database');

      // Attempt to send immediate SMS confirmation to student (best-effort)
      (async function(){
        try {
          const outstandingAfter = Math.max(0, (typeof totalPayable === 'number' ? totalPayable : 0) - (typeof totalPaid === 'number' ? totalPaid : 0));
          // determine phone number
          let phone = window.studentPhone || window.student_phone || window.studentMobile || null;
          if (!phone) {
            try {
              const { data: sdata, error: serr } = await supabase.from('students').select('phone,phone_number').eq('student_id', receipt.student_id).limit(1).maybeSingle();
              if (!serr && sdata) phone = sdata.phone || sdata.phone_number;
            } catch (e) { /* ignore */ }
          }

          function normalize(p){ if(!p) return null; let d=String(p).replace(/\D/g,''); if(d.charAt(0)==='0') d='233'+d.slice(1); return d.length<9?null:d; }
          const formatted = normalize(phone);
          if (!formatted) {
            console.warn('No valid phone found to send payment confirmation for', receipt.student_id);
            return;
          }

          const msg = `GH TECHNICAL — Hi ${receipt.student_name || 'Student'}, we received ${cedis(receipt.amount)} for ${receipt.fee_type} (Ref: ${receipt.reference || receipt.receipt_number || 'N/A'}). Outstanding balance: ${cedis(outstandingAfter)}. Reply HELP for support.`;
          await sendViaProxy([formatted], msg, { student_id: receipt.student_id, receipt: receipt.reference || receipt.receipt_number });
        } catch (e) { console.warn('Could not send payment confirmation SMS:', e); }
      })();
    } else {
      console.warn('Payment completed but could not save to database');
      // Still show receipt even if DB save fails
      showReceipt(receipt);
      showModalMessage('Payment successful! However, there was an issue saving the record. Please take a screenshot of this receipt.');
    }
  } catch (error) {
    console.error('Error in savePaymentWithReceipt:', error);
    showModalMessage('Payment successful but there was an error processing your receipt. Please contact support.');
  }
}

/* ---------- Fixed Paystack Integration ---------- */
function payWithPaystack(feeType, amount, feeBreakdown=''){
  const email = getValidEmail();
  if(!email){ 
    showModalMessage('Valid email required for payment'); 
    return; 
  }
  
  const amt = Number(amount);
  if(!Number.isFinite(amt) || amt <= 0){ 
    showModalMessage('Invalid amount'); 
    return; 
  }

  // Check if Paystack is properly loaded
  if(!window.PaystackPop || !window.PaystackPop.setup){
    showModalMessage('Paystack payment service is currently unavailable. Please try again later.');
    console.error('Paystack not loaded');
    return;
  }

  const ref = `GHTU-${Date.now()}-${Math.floor(Math.random()*1e4)}`;

  const handler = window.PaystackPop.setup({
    key: PAYSTACK_PUBLIC_KEY,
    email: email,
    amount: Math.round(amt * 100), // Convert to kobo
    currency: 'GHS',
    ref: ref,
    metadata: {
      custom_fields: [
        {display_name: 'Student ID', variable_name: 'student_id', value: studentId || ''},
        {display_name: 'Name', variable_name: 'student_name', value: window.studentName || ''},
        {display_name: 'Level', variable_name: 'level', value: window.studentLevel || ''},
        {display_name: 'Department', variable_name: 'department', value: window.studentDept || ''}
      ],
      fee_type: feeType,
      fee_breakdown: feeBreakdown
    },
    callback: function(response) {
      // FIXED: Proper callback handling
      console.log('Paystack callback received:', response);
      
      if(response.status === 'success') {
        // Payment was successful
        savePaymentWithReceipt(feeType, amt, response.reference, feeBreakdown)
          .then(() => {
            console.log('Payment successfully recorded');
          })
          .catch(error => {
            console.error('Failed to save payment record:', error);
            showModalMessage('Payment was successful but there was an issue saving the record. Please contact support with reference: ' + response.reference);
          });
      } else {
        // Payment failed
        showModalMessage('Payment failed: ' + (response.message || 'Unknown error'));
      }
    },
    onClose: function() {
      // User closed the payment modal
      console.log('Payment window closed');
      showModalMessage('Payment was not completed. If you already paid, check your email for confirmation.');
    }
  });

  handler.openIframe();
}

/* ---------- UI helper payment functions ---------- */
window.payTuition = ()=>{
  const selected = document.querySelector('#tuitionModal input[name="tuitionAmount"]:checked');
  if(!selected) { showModalMessage('Select 50% or 100%'); return; }
  const amount = parseFloat(selected.value);
  payWithPaystack('Tuition Fee', amount);
  toggleModal('tuitionModal');
};

window.payOtherFees = ()=>{
  const checkboxes = document.querySelectorAll('#otherFeesModal input[name="otherFee"]:checked');
  if(checkboxes.length===0) { showModalMessage('Select at least one fee'); return; }
  let total=0, breakdown=[];
  checkboxes.forEach(cb=>{
    const [name, price] = (cb.value || '').split('|');
    const amt = Number(price);
    if(Number.isFinite(amt) && amt > 0){
      total += amt;
      breakdown.push(`${name} - GHS ${amt}`);
    }
  });
  payWithPaystack('Other Fees', total, breakdown.join(', '));
  toggleModal('otherFeesModal');
};

/* Student account setup removed from dashboard: form handler omitted */

// Update student information in the dashboard UI
function updateStudentInfoUI() {
  document.getElementById('student-name').textContent = window.studentName || 'Unknown';
  document.getElementById('student-id').textContent = studentId || 'N/A';
  document.getElementById('student-level').textContent = window.studentLevel || 'N/A';
  document.getElementById('student-department').textContent = window.studentDept || 'N/A';
  document.getElementById('student-email').textContent = window.studentEmail || 'N/A';
  const otherEl = document.getElementById('student-othername');
  if(otherEl) otherEl.textContent = window.studentOtherName || 'N/A';
  
  // Update welcome message
  if (window.studentName) {
    document.getElementById('welcome-message').textContent = `Hello ${window.studentName}, welcome back to school! Enjoy your semester`;
  }
}

// Make the student info form readonly/disabled when profile already exists
function setStudentFormReadOnly(readOnly){
  const form = document.getElementById('studentInfoForm');
  if(!form) return;
  const elements = form.querySelectorAll('input, select, textarea, button');
  elements.forEach(el => {
    // Keep the close button active
    if(el.classList && el.classList.contains('close-btn')) return;
    // Leave OK/Close buttons enabled but disable inputs
    if(el.tagName.toLowerCase() === 'button' && (el.classList.contains('confirm-btn') || el.id === 'ackNotificationModalBtn')){
      // keep button clickable to show the cannot-update modal later
      return;
    }
    try{ el.disabled = !!readOnly; }catch(e){}
  });
}

/* ---------- Student notification rendering (dismissible) ---------- */
function renderStudentNotification(){
  try{
    // remove any existing banner
    const existing = document.getElementById('studentNotificationBanner');
    if(existing) existing.remove();

    if(window.studentNotificationUnread && window.studentLastNotification){
      const banner = document.createElement('div');
      banner.id = 'studentNotificationBanner';
      banner.style.cssText = 'position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:9999;background:#fff3cd;border:1px solid #ffeeba;color:#856404;padding:12px 16px;border-radius:6px;box-shadow:0 2px 10px rgba(0,0,0,0.08);max-width:920px;display:flex;align-items:center;gap:12px;';

      const msg = document.createElement('div');
      msg.style.flex = '1';
      msg.innerHTML = escapeHtml(String(window.studentLastNotification || 'You have a new notification.'));

      const actions = document.createElement('div');
      const ack = document.createElement('button');
      ack.id = 'ackNotificationBtn';
      ack.textContent = 'Acknowledge';
      ack.style.cssText = 'background:#856404;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;';
      actions.appendChild(ack);

      banner.appendChild(msg);
      banner.appendChild(actions);
      document.body.prepend(banner);

      ack.addEventListener('click', async function(){
        try{
          await clearStudentNotification();
        } catch(e){ console.error(e); }
        banner.remove();
      });
    }
  } catch(e){ console.error('renderStudentNotification error:', e); }
}

async function clearStudentNotification(){
  if(!studentId) return;
  try{
    const { data, error } = await supabase
      .from('students')
      .update({ notification_unread: false })
      .eq('student_id', studentId.trim())
      .select()
      .maybeSingle();

    if(error){
      console.warn('Could not clear notification:', error.message || error);
      return null;
    }
    window.studentNotificationUnread = false;
    return data;
  } catch(err){ console.error('clearStudentNotification error:', err); }
}

/* =======================================================================
   MANUAL PAYMENT RECEIPT – STORAGE + DB + GATING
   ======================================================================= */

/* Manual receipt/upload feature removed */

/* ---------- Payment History rendering ---------- */
const HISTORY_CACHE_KEY = studentId ? `historyCache:${studentId}` : 'historyCache';

function rowsToHTML(rows) {
  if (!rows || rows.length === 0) {
    return `<tr><td colspan="7" style="text-align:center;padding:16px;color:#666;">No payments found</td></tr>`;
  }
  return rows.map(r => {
    const when = new Date(r.created_at || r.payment_date || Date.now()).toLocaleString();
    const fullName = `${r.firstname || ''} ${r.lastname || ''}`.trim();

    // Build a clear breakdown string. Prefer explicit fee_breakdown; otherwise infer from payment_type.
    let breakdownHtml = '';
    try{
      if(r.fee_breakdown && String(r.fee_breakdown).trim()){
        breakdownHtml = escapeHtml(String(r.fee_breakdown));
      } else {
        const type = (r.payment_type || '').toString().toLowerCase();
        const amt = Number(r.amount) || 0;
        const parts = [];
        if(type.includes('tuition')) parts.push(`Tuition: GHS ${gh(amt)}`);
        else if(type.includes('src')) parts.push(`SRC Dues: GHS ${gh(amt)}`);
        else if(type.includes('medical')) parts.push(`Medical: GHS ${gh(amt)}`);
        else if(type.includes('department')) parts.push(`Departmental: GHS ${gh(amt)}`);
        else parts.push(`Amount: GHS ${gh(amt)}`);
        breakdownHtml = escapeHtml(parts.join(', '));
      }
    }catch(e){ breakdownHtml = escapeHtml(r.fee_breakdown || ''); }

    return `
      <tr style="border-bottom:1px solid #eee;">
        <td style="padding:8px;">${escapeHtml(when)}</td>
        <td style="padding:8px;">${escapeHtml(r.payment_type || '')}</td>
        <td style="padding:8px;">${breakdownHtml}</td>
        <td style="padding:8px;text-align:right;padding-right:12px;">GHS ${gh(r.amount)}</td>
        <td style="padding:8px;">${escapeHtml(r.receipt_number || '')}</td>
        <td style="padding:8px;">${escapeHtml(fullName)}</td>
        <td style="padding:8px;white-space:nowrap;">
          <button class="viewReceiptBtn" data-ref="${escapeHtml(r.transaction_ref || '')}" style="margin-right:6px;padding:6px 8px;border-radius:6px;border:none;background:#4a00e0;color:white;cursor:pointer;">View</button>
          <button class="downloadBtn" data-ref="${escapeHtml(r.transaction_ref || '')}" style="padding:6px 8px;border-radius:6px;border:none;background:#ff6a00;color:white;cursor:pointer;">PDF</button>
        </td>
      </tr>
    `;
  }).join('');
}

function wireHistoryRowButtons(payments){
  setTimeout(()=>{
    document.querySelectorAll('.viewReceiptBtn').forEach(btn=>{
      btn.onclick = ()=>{
        const ref = btn.getAttribute('data-ref');
        const rec = (payments || []).find(x => (x.transaction_ref || '') === ref);
        if(!rec) { showModalMessage('Receipt not found'); return; }
        showReceipt({
          ...rec,
          firstname: rec.firstname || '',
          lastname: rec.lastname || '',
          student_name: `${rec.firstname || ''} ${rec.lastname || ''}`.trim(),
          fee_type: rec.payment_type,
          fee_breakdown: rec.fee_breakdown,
          reference: rec.transaction_ref,
          receipt_number: rec.receipt_number || rec.transaction_ref,
          date_display: new Date(rec.created_at || rec.payment_date || Date.now()).toLocaleString()
        });
      };
    });
    document.querySelectorAll('.downloadBtn').forEach(btn=>{
      btn.onclick = ()=>{
        const ref = btn.getAttribute('data-ref');
        const rec = (payments || []).find(x => (x.transaction_ref || '') === ref);
        if(!rec) { showModalMessage('Receipt not found'); return; }
        downloadReceiptPDF({
          ...rec,
          firstname: rec.firstname || '',
          lastname: rec.lastname || '',
          student_name: `${rec.firstname || ''} ${rec.lastname || ''}`.trim(),
          fee_type: rec.payment_type,
          fee_breakdown: rec.fee_breakdown,
          reference: rec.transaction_ref,
          receipt_number: rec.receipt_number || rec.transaction_ref,
          date_display: new Date(rec.created_at || rec.payment_date || Date.now()).toLocaleString()
        });
      };
    });
  }, 5);
}

async function renderHistoryTable(filter = '', { useCacheFirst = true } = {}, studentIdParam) {
  const sid = studentIdParam || studentId;
  if (!sid) {
    console.warn('[renderHistoryTable] no studentId provided');
    return [];
  }
  const tbody = document.getElementById('historyTbody');
  if (!tbody) return [];

  const q = String(filter || '').trim().toLowerCase();

  // 1) Instant render from cache so it "survives" refresh
  if (useCacheFirst) {
    try {
      const cached = JSON.parse(localStorage.getItem(HISTORY_CACHE_KEY) || 'null');
      if (cached && Array.isArray(cached.rows)) {
        const filtered = cached.rows.filter(r => {
          if (!q) return true;
          return (
            String(r.payment_type || '').toLowerCase().includes(q) ||
            String(r.transaction_ref || '').toLowerCase().includes(q) ||
            String(r.receipt_number || '').toLowerCase().includes(q) ||
            String(r.firstname || '').toLowerCase().includes(q) ||
            String(r.lastname || '').toLowerCase().includes(q) ||
            String(r.amount || '').toLowerCase().includes(q)
          );
        });
        tbody.innerHTML = rowsToHTML(filtered);
        wireHistoryRowButtons(cached.rows);
      }
    } catch(_) {}
  }

  // 2) Fresh fetch (order by 'created_at')
  try {
    const { data: payments, error } = await supabase
      .from('payments')
      .select('*')
      .eq('student_id', sid)
        .in('status', ['paid','success'])
      .order('created_at', { ascending: false });

    if (error) {
      console.error('[renderHistoryTable] fetch error:', error);
      if (!useCacheFirst) {
        tbody.innerHTML = '<tr><td colspan="7">Error fetching payments</td></tr>';
      }
      return [];
    }

    // Persist to cache so table survives next refresh
    try {
      localStorage.setItem(HISTORY_CACHE_KEY, JSON.stringify({ rows: payments || [], ts: Date.now() }));
    } catch(_) {}

    const filtered = (payments || []).filter(r => {
      if (!q) return true;
      return (
        String(r.payment_type || '').toLowerCase().includes(q) ||
        String(r.transaction_ref || '').toLowerCase().includes(q) ||
        String(r.receipt_number || '').toLowerCase().includes(q) ||
        String(r.firstname || '').toLowerCase().includes(q) ||
        String(r.lastname || '').toLowerCase().includes(q) ||
        String(r.amount || '').toLowerCase().includes(q)
      );
    });

    tbody.innerHTML = rowsToHTML(filtered);
    wireHistoryRowButtons(payments || []);
    console.log('[renderHistoryTable] rendered rows:', (payments||[]).length);
    return payments || [];
  } catch (err) {
    console.error(err);
    if (!useCacheFirst) {
      tbody.innerHTML = '<tr><td colspan="7">Error loading payments</td></tr>';
    }
    return [];
  }
}
window.renderHistoryTable = renderHistoryTable;

/* ---------- Registration access logic (avoid double-counting) ---------- */
function parseBreakdownToMap(breakdown){
  const map = { src:0, medical:0, departmental:0, tuition:0 };
  if(!breakdown) return map;
  const items = String(breakdown).split(',');
  items.forEach(piece => {
    const lower = piece.toLowerCase();
    const n = parseFloat(piece.replace(/[^\d.]/g,'')) || 0;
    if(lower.includes('src')) map.src += n;
    else if(lower.includes('medical')) map.medical += n;
    else if(lower.includes('department')) map.departmental += n;
    else if(lower.includes('tuition')) map.tuition += n;
  });
  return map;
}

async function hasRegistrationAccess(studentIdParam){
  // Required amounts for registration (in GHS)
  const REQUIRED = { 
    tuition: 2040,        // 80% of GHS 2,550
    src: 50,              // SRC Dues
    medical: 80,          // Medical Dues
    departmental: 50      // Departmental Dues
  };
  let tuitionPaid=0, srcPaid=0, medPaid=0, deptPaid=0;

  const { data: payments, error } = await supabase
    .from('payments')
    .select('*')
    .eq('student_id', studentIdParam)
      .in('status', ['paid','success']);

  if(error){ console.error('Fetch payments failed:', error); return false; }

  // Reuse the summary helper so logic is consistent across the app
  try{
    const summary = await fetchPaymentsSummary(studentIdParam);
    tuitionPaid = summary.tuitionPaid || 0;
    srcPaid = summary.srcPaid || 0;
    medPaid = summary.medPaid || 0;
    deptPaid = summary.deptPaid || 0;
    // ensure totalPaid is set so other parts of the UI can rely on it
    totalPaid = Number(summary.totalPaid) || totalPaid;
    outstandingBalance = Math.max(0, totalPayable - totalPaid);
  }catch(e){ console.warn('hasRegistrationAccess summary fallback', e); }

  const tuitionOK = tuitionPaid >= (REQUIRED.tuition - 1e-6);
  const srcOK     = srcPaid     >= (REQUIRED.src - 1e-6);
  const medOK     = medPaid     >= (REQUIRED.medical - 1e-6);
  const deptOK    = deptPaid    >= (REQUIRED.departmental - 1e-6);

  console.log('Registration eligibility check:', {tuitionPaid, tuitionOK, srcPaid, srcOK, medPaid, medOK, deptPaid, deptOK});

  return tuitionOK && srcOK && medOK && deptOK;
}

/* ---------- Registration handler (now checks pending manual) ---------- */
window.registerCourses = async ()=>{
  if(!studentId){ showModalMessage('No student ID found'); return; }
  try{
    // Previously we blocked registration when manual receipts were pending.
    // Manual receipts are now auto-approved, so skip blocking on pending uploads.
    // 2) Normal eligibility rule
    const allowed = await hasRegistrationAccess(studentId);
    if(!allowed){ toggleModal('restrictionModal'); return; }
    // 3) Proceed — open course registration modal in-dashboard
    try{ if(window.openCourseRegister) { window.openCourseRegister(); return; } }catch(e){}
    // fallback: redirect to registration page
    window.location.href = 'register.html';
  }catch(err){
    console.error(err);
    showModalMessage('Error checking registration eligibility.');
  }
};

/* ---------- Debug Function: Check Supabase Connection ---------- */
async function checkSupabaseConnection() {
  try {
    // Try a lightweight select on the students table to verify connectivity and permissions
    const { data, error } = await supabase
      .from('students')
      .select('student_id')
      .limit(1);

    if (error) {
      console.error('Supabase connection test failed:', error);
      return false;
    }

    console.log('Supabase connection successful');
    return true;
  } catch (err) {
    console.error('Supabase connection test error:', err);
    return false;
  }
}

/* ---------- Initialize Dashboard with Student Form Check ---------- */
async function initDashboard(){
  // Test Supabase connection on startup
  const isConnected = await checkSupabaseConnection();
  if (!isConnected) {
    console.warn('Supabase connection issue detected');
  }

  // Student account onboarding removed from dashboard. If a studentId exists,
  // fetch profile for display purposes; otherwise, just update UI from local values.
  try{ if(studentId) await fetchStudentProfile(); }catch(e){}
  updateStudentInfoUI();

  // Restore totals
  try {
    const storedTotals = JSON.parse(localStorage.getItem('dashboardTotals') || 'null');
    if(storedTotals){
      totalPayable = Number(storedTotals.totalPayable) || totalPayable;
      totalPaid    = Number(storedTotals.totalPaid) || 0;
      outstandingBalance = Number(storedTotals.outstandingBalance) || (totalPayable - totalPaid);
    }
  } catch(e){}

  // Fetch authoritative totals and render UI
  await refreshTotalsFromDB();

  updateDashboardUI();
  // renderHistoryTable is called inside refreshTotalsFromDB

  // Start realtime subscription to keep stat cards updated when payments change
  try{ await setupRealtimePaymentsSubscription(); }catch(e){ console.warn('Realtime setup in init failed', e); }

  // Expose a manual force-refresh helper for debugging and quick sync
  window.forceRefreshPayments = async function(){
    try{
      console.log('[forceRefreshPayments] invoked, studentId=', studentId);
      const res = await refreshTotalsFromDB();
      console.log('[forceRefreshPayments] refresh result:', res);
      return res;
    }catch(e){ console.error('[forceRefreshPayments] failed', e); }
  };

  // Wire History modal controls (safe-nulls)
  const openBtn  = document.getElementById('openHistoryBtn');
  const searchIn = document.getElementById('historySearch');
  const clearBtn = document.getElementById('clearHistoryBtn');

  openBtn?.addEventListener('click', ()=>{ renderHistoryTable('', { useCacheFirst: false }, studentId).then(()=> toggleModal('historyModal')); });
  searchIn?.addEventListener('input', (e)=> renderHistoryTable(e.target.value || '', { useCacheFirst: false }, studentId));
  clearBtn?.addEventListener('click', ()=>{ if(searchIn) searchIn.value=''; renderHistoryTable('', { useCacheFirst: false }, studentId); });

  // Prevent backdrop-clicks from closing the history modal when interacting with its content
  try{
    const histModal = document.getElementById('historyModal');
    if(histModal){
      const content = histModal.querySelector('.modal-content');
      if(content) content.onclick = (e)=> e.stopPropagation();
      // ensure clicking backdrop still closes
      histModal.onclick = closeIfBackdrop;
    }
  }catch(e){ console.warn('history modal hookup failed', e); }

  // Manual receipt/upload feature removed
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initDashboard);
} else {
  initDashboard();
}

// Setup a realtime listener for payments so the stat cards update immediately
async function setupRealtimePaymentsSubscription(){
  try{
    if(!window.supabase) return;
    if(!studentId) return;
    // avoid duplicate subscriptions
    if(window._paymentsSubscription) return;

    const filter = `student_id=eq.${studentId}`;
    try{
      const channel = window.supabase.channel(`payments:student:${studentId}`);
      window._paymentsSubscription = channel
        .on('postgres_changes', { event: '*', schema: 'public', table: 'payments', filter }, async (payload)=>{
          console.log('Payments realtime payload:', payload);
          // Refresh totals, history and register button when payments change
          try{ await refreshTotalsFromDB(); await refreshRegisterButtonState(); }catch(e){ console.warn(e); }
        })
        .subscribe();
    }catch(err){
      // older/newer supabase clients may use different APIs; fall back to polling
      console.warn('Realtime channel subscribe failed, falling back to polling:', err);
      if(window._paymentsInterval) return;
      window._paymentsInterval = setInterval(()=>{ try{ refreshTotalsFromDB(); }catch(e){} }, 5000);
    }
  }catch(e){ console.warn('setupRealtimePaymentsSubscription failed', e); }
}

// Clean up subscription on page unload
window.addEventListener('beforeunload', async ()=>{
  try{
    if(window._paymentsInterval){ clearInterval(window._paymentsInterval); window._paymentsInterval = null; }
    if(window._paymentsSubscription && typeof window._paymentsSubscription.unsubscribe === 'function'){
      try{ await window._paymentsSubscription.unsubscribe(); }catch(e){ console.warn('unsubscribe failed', e); }
      window._paymentsSubscription = null;
    }
  }catch(e){}
});

window.openTuitionModal = ()=>toggleModal('tuitionModal');
window.openOtherFeesModal = ()=>toggleModal('otherFeesModal');



// Add this JavaScript code
document.addEventListener('DOMContentLoaded', function() {
  // Ripple effect for buttons
  function createRipple(event) {
    const button = event.currentTarget;
    const circle = document.createElement('span');
    const diameter = Math.max(button.clientWidth, button.clientHeight);
    const radius = diameter / 2;

    circle.style.width = circle.style.height = `${diameter}px`;
    circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
    circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
    circle.classList.add('ripple');

    const ripple = button.getElementsByClassName('ripple')[0];
    if (ripple) ripple.remove();

    button.appendChild(circle);
  }

  // Add ripple to all buttons
  const buttons = document.querySelectorAll('button');
  buttons.forEach(button => {
    button.addEventListener('click', createRipple);
  });

  // Expose inline handler functions to window to support onclick attributes
  (function(){
    const fns = [
      'toggleModal','closeIfBackdrop','openTuitionModal','openOtherFeesModal','registerCourses',
      'payTuition','payOtherFees','renderHistoryTable','downloadReceiptPDF','showReceipt','printReceipt'
    ];
    fns.forEach(name=>{
      try{
        if(typeof window[name] !== 'function'){
          const v = eval(name);
          if(typeof v === 'function') window[name] = v;
        }
      }catch(e){}
    });
  })();

  // Input field animations
  const inputs = document.querySelectorAll('input, select');
  inputs.forEach(input => {
    // Add floating labels
    if (input.type !== 'checkbox') {
      const label = input.previousElementSibling;
      if (label && label.tagName === 'LABEL') {
        const floatingLabel = label.cloneNode(true);
        floatingLabel.classList.add('floating-label');
        input.parentNode.appendChild(floatingLabel);
      }
    }

    // Focus effects
    input.addEventListener('focus', function() {
      this.parentElement.classList.add('input-glow');
    });

    input.addEventListener('blur', function() {
      this.parentElement.classList.remove('input-glow');
    });

    // Shake animation for invalid inputs
    input.addEventListener('invalid', function() {
      this.classList.add('shake');
      setTimeout(() => this.classList.remove('shake'), 400);
    });
  });

  // Form submission enhancement
  const loginForm = document.getElementById('login-form');
  if (loginForm) {
    loginForm.addEventListener('submit', function(e) {
      const inputs = this.querySelectorAll('input[required], select[required]');
      let isValid = true;

      inputs.forEach(input => {
        if (!input.value.trim()) {
          input.classList.add('shake');
          setTimeout(() => input.classList.remove('shake'), 400);
          isValid = false;
        }
      });

      if (!isValid) {
        e.preventDefault();
        // Add form shake
        this.classList.add('shake');
        setTimeout(() => this.classList.remove('shake'), 400);
      }
    });
  }

  // Typing effect for loading screen
  function typeWriter(element, text, speed = 50) {
    let i = 0;
    element.innerHTML = '';
    function typing() {
      if (i < text.length) {
        element.innerHTML += text.charAt(i);
        i++;
        setTimeout(typing, speed);
      }
    }
    typing();
  }

  // Initialize typing effect when loading screen appears
  const loadingText = document.querySelector('.loading-content p');
  if (loadingText) {
    const originalText = loadingText.textContent;
    // This will be triggered when loading screen is shown
    window.showLoadingScreen = function() {
      typeWriter(loadingText, originalText);
    };
  }
});

    document.addEventListener('DOMContentLoaded', function() {
      const supportBtn = document.getElementById('supportBtn');
      const supportChatModal = document.getElementById('supportChatModal');
      const closeChatBtn = document.getElementById('closeChatBtn');
      const chatBody = document.getElementById('chatBody');
      const chatInput = document.getElementById('chatInput');
      const sendMessageBtn = document.getElementById('sendMessageBtn');
      
      // Chat state
      let chatState = 0; // 0: greeting, 1: how are you, 2: help type, 3: final message
      
      // Toggle chat modal
      supportBtn.addEventListener('click', function() {
        supportChatModal.classList.toggle('active');
        if (supportChatModal.classList.contains('active')) {
          startChat();
        }
      });
      
      closeChatBtn.addEventListener('click', function() {
        supportChatModal.classList.remove('active');
        resetChat();
      });
      
      // Send message on button click
      sendMessageBtn.addEventListener('click', sendMessage);
      
      // Send message on Enter key
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      // Initialize chat
      function startChat() {
        resetChat();
        addBotMessage("Hello! Welcome to GH Technical University support. How can I assist you today?");
        setTimeout(() => {
          addBotMessage("How are you doing today?", [
            "I'm doing great, thanks!",
            "I'm having some issues",
            "I need help with something"
          ]);
          chatState = 1;
        }, 1000);
      }
      
      // Reset chat
      function resetChat() {
        chatBody.innerHTML = '';
        chatState = 0;
      }
      
      // Add bot message to chat
      function addBotMessage(text, options = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';
        messageDiv.textContent = text;
        chatBody.appendChild(messageDiv);
        
        if (options.length > 0) {
          const optionsContainer = document.createElement('div');
          optionsContainer.className = 'options-container';
          
          options.forEach(option => {
            const optionBtn = document.createElement('button');
            optionBtn.className = 'option-btn';
            optionBtn.textContent = option;
            optionBtn.addEventListener('click', () => {
              addUserMessage(option);
              handleUserResponse(option);
            });
            optionsContainer.appendChild(optionBtn);
          });
          
          chatBody.appendChild(optionsContainer);
        }
        
        scrollToBottom();
      }
      
      // Add user message to chat
      function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.textContent = text;
        chatBody.appendChild(messageDiv);
        scrollToBottom();
      }
      
      // Handle user response based on chat state
      function handleUserResponse(response) {
        switch(chatState) {
          case 1: // How are you doing
            if (response.includes("great")) {
              addBotMessage("That's wonderful to hear! 😊");
            } else {
              addBotMessage("I'm sorry to hear that. Let's see how we can help.");
            }
            
            setTimeout(() => {
              addBotMessage("What kind of help do you need?", [
                "Payment Issues",
                "Registration Problems",
                "Technical Support",
                "Other Issues"
              ]);
              chatState = 2;
            }, 1000);
            break;
            
          case 2: // Help type
            addBotMessage(`I see you need help with ${response}.`);
            
            setTimeout(() => {
              addBotMessage("For personalized assistance, you can contact our support team directly on WhatsApp.");
              
              const whatsappBtn = document.createElement('a');
              whatsappBtn.href = "https://wa.me/233539816189?text=Hello%2C%20I%20need%20help%20with%20my%20student%20dashboard";
              whatsappBtn.className = "whatsapp-btn";
              whatsappBtn.target = "_blank";
              whatsappBtn.innerHTML = '<i class="fab fa-whatsapp"></i> Chat on WhatsApp (0539816189)';
              
              chatBody.appendChild(whatsappBtn);
              chatState = 3;
            }, 1000);
            break;
            
          case 3: // After showing WhatsApp option
            // Just continue the conversation
            break;
        }
      }
      
      // Send message from input
      function sendMessage() {
        const message = chatInput.value.trim();
        if (message) {
          addUserMessage(message);
          chatInput.value = '';
          
          // Bot response logic
          setTimeout(() => {
            if (chatState === 3) {
              addBotMessage("For faster assistance, please click the WhatsApp button above to chat directly with our support team.");
            } else {
              addBotMessage("I understand. For personalized assistance with this issue, please contact our support team on WhatsApp using the button above.");
            }
          }, 1000);
        }
      }
      
      // Scroll chat to bottom
      function scrollToBottom() {
        chatBody.scrollTop = chatBody.scrollHeight;
      }
    });

    // Mobile nav helpers: close/open and keyboard handling
    (function(){
      function closeMobileNav(){
        const s = document.querySelector('.sidebar');
        if(!s) return;
        console.debug('closeMobileNav called');
        s.classList.remove('mobile');
        try{
          // remove inline styles applied when opening
          s.style.position = '';
          s.style.left = '';
          s.style.top = '';
          s.style.width = '';
          s.style.height = '';
          s.style.transform = '';
          s.style.transition = '';
          s.style.zIndex = '';
          document.body.style.overflow = '';
        }catch(e){}
        // if we moved the sidebar to body, restore it to its original place
        try{
          if(s.__origParent){
            const parent = s.__origParent;
            const next = s.__nextSibling || null;
            parent.insertBefore(s, next);
            delete s.__origParent;
            delete s.__nextSibling;
            console.debug('sidebar restored to original parent');
          }
        }catch(e){ console.debug('error restoring sidebar parent', e); }
      }
      function openMobileNav(){
        const s = document.querySelector('.sidebar');
        if(!s) return;
        console.debug('openMobileNav called');
        // If the sidebar is inside a clipped container, temporarily move it to body
        try{
          if(!s.__origParent){
            s.__origParent = s.parentNode;
            s.__nextSibling = s.nextSibling;
            document.body.appendChild(s);
            console.debug('sidebar moved to body to avoid clipping');
          }
        }catch(e){ console.debug('failed to move sidebar to body', e); }
        s.classList.add('mobile');
        try{
          // Ensure the sidebar becomes an overlay on mobile devices even if CSS rules don't apply
          s.style.position = 'fixed';
          s.style.left = '0';
          s.style.top = '0';
          s.style.width = '85%';
          s.style.maxWidth = '360px';
          s.style.height = '100%';
          s.style.transform = 'translateX(0)';
          s.style.transition = 'transform 260ms ease';
          s.style.zIndex = '200000';
          // prevent background scroll while menu open
          document.body.style.overflow = 'hidden';
        }catch(e){ console.debug('error applying sidebar styles', e); }
        // focus first link for accessibility after animation
        setTimeout(()=>{ document.querySelector('.sidebar a')?.focus(); }, 320);
      }

      // Expose globally for inline onclick used by the markup
      window.closeMobileNav = closeMobileNav;
      window.openMobileNav = openMobileNav;

      // Ensure menu-toggle opens mobile nav and focuses first link when used (supports click and touch)
      document.querySelectorAll('.menu-toggle').forEach(btn=>{
        const openHandler = (e)=>{
          try{ if(e && typeof e.preventDefault === 'function') e.preventDefault(); }catch(_){ }
          console.debug('menu-toggle clicked');
          try{ openMobileNav(); }catch(err){
            // fallback: toggle the class directly
            const s = document.querySelector('.sidebar'); if(s) s.classList.toggle('mobile');
          }
          setTimeout(()=>document.querySelector('.sidebar a')?.focus(), 320);
        };
        btn.addEventListener('click', openHandler);
        // Use touchend/non-passive to ensure the handler can run on touch devices
        btn.addEventListener('touchend', openHandler, { passive: false });
      });

      // Close on Escape
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          const s = document.querySelector('.sidebar');
          if(s && s.classList.contains('mobile')) closeMobileNav();
        }
      });

      // Close menu when a nav link is clicked (mobile)
      document.addEventListener('click', function(e){
        const target = e.target;
        if(!target) return;
        if(target.closest && target.closest('.sidebar') && target.tagName === 'A'){
          const s = document.querySelector('.sidebar');
          if(s && s.classList.contains('mobile')) s.classList.remove('mobile');
        }
      });
    })();

      // Capture-phase delegated handlers to ensure menu-toggle clicks are handled
      // even if other scripts stop propagation or add competing handlers.
      (function(){
        function handleMenuToggleCapture(e){
          try{
            const btn = e.target && e.target.closest && e.target.closest('.menu-toggle');
            if(!btn) return;
            console.debug('capture-phase menu-toggle event');
            if(typeof openMobileNav === 'function'){
              openMobileNav();
            } else {
              const s = document.querySelector('.sidebar'); if(s) s.classList.toggle('mobile');
            }
            // Prevent duplicate handling by other listeners
            try{ e.preventDefault(); }catch(_){ }
            try{ e.stopPropagation(); }catch(_){ }
          }catch(err){ console.debug('menu-toggle capture handler error', err); }
        }
        document.addEventListener('click', handleMenuToggleCapture, true);
        // Also handle pointerdown for faster response on touch devices
        document.addEventListener('pointerdown', handleMenuToggleCapture, true);
      })();

  </script>
  <!-- SMS proxy integration: configure your serverless endpoint URL below -->
  <!-- Global message modal (replaces alert) -->
  <div id="globalMessageModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="globalMessageTitle">Notice</h2>
        <button class="close-btn" onclick="toggleModal('globalMessageModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="globalMessageBody" style="white-space:pre-wrap;">Message</div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="toggleModal('globalMessageModal')">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Configure SMS proxy endpoint (set this to your deployed server/edge function URL)
    // Example: window.PROXY_ENDPOINT = 'https://sms-proxy-yourhost.onrender.com/send-sms';
    if (typeof window.USE_PROXY === 'undefined') window.USE_PROXY = true;
    if (typeof window.PROXY_ENDPOINT === 'undefined') window.PROXY_ENDPOINT = 'https://fyriapqeztevzkcaaiqw.supabase.co/functions/v1/hyper-action';
  </script>
  <!-- Course Registration Modal (dashboard inline) -->
  <div id="courseRegisterModal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="close-btn" onclick="toggleModal('courseRegisterModal')">&times;</button>
      <h3>Course Registration</h3>
      <div id="courseRegisterBody">
        <p>Loading course options...</p>
      </div>
      <div style="text-align:right;margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button class="btn-secondary" id="courseRegisterCancel">Cancel</button>
        <button class="confirm-btn" id="courseRegisterConfirmBtn">Confirm Registration</button>
      </div>
    </div>
  </div>

  <script>
    // Minimal course mapping copied from register.html to render student-specific courses
    const DASHBOARD_SCHOOL_DATA = {
      "Media School": {
        programs: {
          "Journalism And Media Art": [
            "TV PRESENTING / TV JOURNALISM",
            "RADIO PRESENTING / RADIO JOURNALISM",
            "RADIO, TV & FILM PRODUCTION",
            "PROFESSIONAL ACTING",
            "EVENT MANAGEMENT"
          ],
          "Journalism And Media Studies": [
            "TV PRESENTING / TV JOURNALISM",
            "RADIO PRESENTING / RADIO JOURNALISM",
            "NEWSPAPER REPORTING / PRINT JOURNALISM",
            "MEDIA LAW & ETHICS",
            "MEDIA MARKETING"
          ],
          "TV & Film Production": [
            "CAMERA OPERATION AND LIGHTING",
            "DIGITAL VIDEO EDITING",
            "SOUND PRODUCTION / ENGINEERING",
            "DIRECTING AND SCRIPT WRITING",
            "POST PRODUCTION DESIGN"
          ],
          "Multimedia Production": [
            "DIGITAL VIDEO EDITING",
            "MULTIMEDIA SOUND PRODUCTION",
            "GRAPHIC DESIGNING",
            "ANIMATIONS",
            "POST PRODUCTION DESIGN"
          ]
        },
        coreCourses: ["COMMUNICATION SKILLS","AFRICAN STUDIES","ICT","ENTREPRENEURSHIP","PRODUCTION MANAGEMENT"]
      },
      "Cosmetology School": {
        courses: ["MAKE-UP ARTISTRY","NAIL TECHNOLOGY","BODY THERAPY","HAIR TECHNOLOGY","SALON AND SPA MANAGEMENT"],
        coreCourses: ["COMMUNICATION SKILLS","AFRICAN STUDIES","ICT","ENTREPRENEURSHIP","PRODUCTION MANAGEMENT"]
      },
      "School of Fashion": {
        courses: ["PATTERN DRAFTING","GARMENT CONSTRUCTION","CLOTHING AND TEXTILES","MILLINERY AND ACCESSORIES","FASHION DESIGN"],
        coreCourses: ["COMMUNICATION SKILLS","AFRICAN STUDIES","ICT","ENTREPRENEURSHIP","PRODUCTION MANAGEMENT"]
      },
      "Catering School": {
        courses: ["FOOD & BEVERAGE PRODUCTION","PASTRY, CAKE, AND SUGAR CRAFT","BALLOON, FLORAL DECORATION AND EVENT MANAGEMENT","CATERING SERVICE MANAGEMENT","HOTEL, TOURISM & HOSPITALITY MANAGEMENT"],
        coreCourses: ["COMMUNICATION SKILLS","AFRICAN STUDIES","ICT","ENTREPRENEURSHIP","PRODUCTION MANAGEMENT"]
      },
      "School of Technology": {
        courses: ["COMPUTER HARDWARE","COMPUTER SOFTWARE","COMPUTER NETWORKING","BROADCAST TECHNOLOGY","SECURITY SYSTEMS"],
        coreCourses: ["COMMUNICATION SKILLS","AFRICAN STUDIES","ICT","ENTREPRENEURSHIP","PRODUCTION MANAGEMENT"]
      }
    };

    // Helper — find best matching school/program for the current student profile
    function detectStudentSchoolAndProgram(){
      // Prefer fields populated by fetchStudentProfile
      const schoolVal = (window.studentSchool || window.studentDept || window.studentDepartment || '').toString().trim();
      const programVal = (window.studentProgram || window.studentCourseType || window.studentDept || '').toString().trim();
      // exact school match
      if(schoolVal && DASHBOARD_SCHOOL_DATA[schoolVal]) return { school: schoolVal, program: programVal || null };
      // try to find a school whose key appears inside any of the profile strings
      const keys = Object.keys(DASHBOARD_SCHOOL_DATA);
      const hay = (schoolVal + ' ' + programVal + ' ' + (window.studentDept||'') + ' ' + (window.studentName||'')).toLowerCase();
      for(const k of keys){ if(hay.indexOf(k.toLowerCase().split(' ')[0]) !== -1) return { school: k, program: programVal||null }; }
      // fallback to first school
      return { school: keys[0], program: programVal||null };
    }

    // Build and open the modal with courses specific to the student
    window.openCourseRegister = async function(){
      try{
        if(!studentId){ showModalMessage('No student ID found'); return; }
        // Ensure latest profile + eligibility info (do not block modal display)
        await fetchStudentProfile();
        const allowed = await hasRegistrationAccess(studentId);
        // Fetch detailed payment summary to show what is missing (if any)
        let paymentSummary = { tuitionPaid:0, srcPaid:0, medPaid:0, deptPaid:0, totalPaid:0 };
        try{ paymentSummary = await fetchPaymentsSummary(studentId) || paymentSummary; }catch(e){ console.warn('Could not fetch payment summary for eligibility display', e); }

        const info = detectStudentSchoolAndProgram();
        const school = info.school;
        const program = info.program;
        const data = DASHBOARD_SCHOOL_DATA[school] || {};

        const body = document.getElementById('courseRegisterBody');
        if(!body) return;
        // header
        body.innerHTML = `
          <div style="margin-bottom:12px;">
            <div><strong>Name:</strong> ${escapeHtml(window.studentName || '')}</div>
            <div><strong>ID:</strong> ${escapeHtml(studentId || '')}</div>
            <div><strong>Level:</strong> ${escapeHtml(window.studentLevel || '')}</div>
            <div><strong>School:</strong> ${escapeHtml(school)}</div>
            <div style="margin-top:8px;"><strong>Program:</strong> <span id="crProgramLabel">${escapeHtml(program || '')}</span></div>
          </div>
          <div id="crEligibility" style="margin-bottom:12px;padding:10px;border-radius:8px;background:${allowed? '#e6ffed':'#fff4f4'};border:1px solid ${allowed? '#d4f5d7':'#ffd6d6'};color:${allowed? '#0b6926':'#7a1a1a'};">
            ${allowed ? '<strong>Eligible to register.</strong> You have paid the required fees.' : '<strong>Registration blocked:</strong> Required fees not yet paid.'}
            <div style="margin-top:6px;font-size:13px;color:#333;">Tuition paid: GHS ${gh(paymentSummary.tuitionPaid || 0)} • SRC: GHS ${gh(paymentSummary.srcPaid || 0)} • Medical: GHS ${gh(paymentSummary.medPaid || 0)} • Departmental: GHS ${gh(paymentSummary.deptPaid || 0)}</div>
            ${!allowed ? '<div style="margin-top:8px;font-size:13px;color:#333;">Pay required fees to enable the <em>Confirm Registration</em> button. You may pay Tuition or Other Fees from the Payments section.</div>' : ''}
          </div>
        `;

        // program selector if there are multiple programs
        if(data.programs){
          const programs = Object.keys(data.programs);
          if(!program || programs.indexOf(program) === -1){
            const selectHtml = ['<div class="form-group"><label>Select Program</label><select id="crProgramSelect" class="form-control">'];
            selectHtml.push('<option value="">-- Select program --</option>');
            programs.forEach(p=> selectHtml.push(`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`));
            selectHtml.push('</select></div>');
            body.innerHTML += selectHtml.join('');
          }
        }

        // Build courses list
        const coursesContainer = document.createElement('div');
        coursesContainer.style.maxHeight = '45vh';
        coursesContainer.style.overflow = 'auto';
        coursesContainer.style.paddingTop = '8px';

        let courseList = [];
        if(data.programs){
          const chosen = program || (document.getElementById('crProgramSelect')?.value) || null;
          if(chosen && data.programs[chosen]) courseList = data.programs[chosen];
          else {
            // if none chosen yet, pick first program's courses
            const pkeys = Object.keys(data.programs);
            if(pkeys.length) courseList = data.programs[pkeys[0]] || [];
          }
        } else if(data.courses){
          courseList = data.courses;
        }

        // Add checkboxes for the courses
        const ul = document.createElement('div');
        courseList.forEach((c, idx)=>{
          const id = `cr_course_${idx}`;
          const wrap = document.createElement('div');
          wrap.style.display = 'flex'; wrap.style.alignItems = 'center'; wrap.style.gap = '10px'; wrap.style.padding = '8px 0';
          const cb = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value = c;
          const label = document.createElement('label'); label.htmlFor = id; label.style.flex='1'; label.textContent = c;
          wrap.appendChild(cb); wrap.appendChild(label);
          ul.appendChild(wrap);
        });

        // core courses section
        const coreList = data.coreCourses || [];
        if(coreList.length){
          const coreHdr = document.createElement('div'); coreHdr.style.marginTop='12px'; coreHdr.innerHTML = '<strong>Core Courses (compulsory)</strong>';
          coursesContainer.appendChild(coreHdr);
          coreList.forEach((cc, i)=>{
            const id = `cr_core_${i}`;
            const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='10px'; wrap.style.padding='6px 0';
            const cb = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value = cc; cb.className='cr-core-course'; cb.checked = true;
            const label = document.createElement('label'); label.htmlFor = id; label.style.flex='1'; label.textContent = cc + ' (CORE)';
            wrap.appendChild(cb); wrap.appendChild(label);
            coursesContainer.appendChild(wrap);
          });
        }

        // Append selectable courses after core list
        const selectableHdr = document.createElement('div'); selectableHdr.style.marginTop='12px'; selectableHdr.innerHTML = '<strong>Program Courses</strong>';
        coursesContainer.appendChild(selectableHdr);
        coursesContainer.appendChild(ul);

        body.appendChild(coursesContainer);

        // wire program select change to rebuild course list (simple approach: reload modal)
        const programSelect = document.getElementById('crProgramSelect');
        if(programSelect){ programSelect.addEventListener('change', function(){ openCourseRegister(); }); }

        // show the modal
        toggleModal('courseRegisterModal');

        // wire confirm/cancel
        document.getElementById('courseRegisterCancel')?.addEventListener('click', ()=> toggleModal('courseRegisterModal'));
        // Disable or enable confirm button based on eligibility
        const confirmBtnEl = document.getElementById('courseRegisterConfirmBtn');
        if(confirmBtnEl){
          confirmBtnEl.disabled = !allowed;
          confirmBtnEl.title = allowed ? 'Confirm your course registration' : 'You must pay required fees before registering';
        }

        document.getElementById('courseRegisterConfirmBtn')?.addEventListener('click', async function(){
          try{
            // collect selections
            const selected = Array.from(document.querySelectorAll('#courseRegisterBody input[type="checkbox"]'))
              .filter(n=>n.checked && !n.classList.contains('cr-core-course'))
              .map(n=>n.value);
            const selectedCore = Array.from(document.querySelectorAll('#courseRegisterBody input.cr-core-course'))
              .filter(n=>n.checked).map(n=>n.value);
            if(selectedCore.length === 0){ showModalMessage('You must include core courses before confirming.'); return; }
            if(selected.length === 0){ showModalMessage('Please select at least one program course.'); return; }

            // final eligibility check before attempting save
            if(!allowed){ showModalMessage('You are not eligible to register. Please complete required payments first.'); return; }

            const chosenProgram = document.getElementById('crProgramSelect')?.value || program || null;
            const payload = {
              level: window.studentLevel || null,
              school: school,
              program: chosenProgram || null
            };

            // Save registration row
            await saveRegistrationFromDashboard(payload, selected, selectedCore);
            toggleModal('courseRegisterModal');
          }catch(e){ console.error('confirm registration failed', e); showModalMessage('Failed to register courses'); }
        });

      }catch(e){ console.error('openCourseRegister failed', e); showModalMessage('Could not open registration modal'); }
    };

    // Save registration into Supabase (simple insert similar to register.html saveRegistration)
    async function saveRegistrationFromDashboard(payload, selectedCourses, selectedCore){
      try{
        if(!window.supabase) {
          // fallback: store locally
          const row = { student_id: studentId, level: payload.level, school: payload.school, program: payload.program, courses: selectedCourses, core_courses: selectedCore, status: 'pending', created_at: new Date().toISOString() };
          try{ localStorage.setItem('lastRegistrationDraft', JSON.stringify(row)); showToast('Saved registration locally (offline)', 'success'); return; }catch(e){ showToast('Could not save registration locally', 'error'); return; }
        }

        const insertRow = { student_id: studentId, level: payload.level, school: payload.school, program: payload.program || null, courses: selectedCourses || [], core_courses: selectedCore || [], status: 'pending', created_at: new Date().toISOString() };
        const { data, error } = await window.supabase.from('registrations').insert(insertRow).select();
        if(error){ console.error('Registration save error', error); showToast('Could not save registration (server error)', 'error'); return; }
        showToast('Registration submitted — check My Courses for status', 'success');
        // cache last selected courses for My Courses fallback
        try{ localStorage.setItem('lastSelectedCourses', JSON.stringify([...new Set([...(selectedCore||[]), ...(selectedCourses||[])]) ])); }catch(e){}
        // attempt to refresh history/hints
        try{ renderHistoryTable('', { useCacheFirst: false }, studentId); }catch(e){}
        return data;
      }catch(e){ console.error(e); showToast('Failed to save registration', 'error'); }
    }
  </script>
  <!-- Password reset UX removed -->
</body>
</html>